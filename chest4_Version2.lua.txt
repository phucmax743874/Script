--getgenv().team = "Marines" -- Change to "Pirates" if preferred
repeat wait() until game:IsLoaded() and game.Players.LocalPlayer:FindFirstChild("DataLoaded")

-- =================== UI (Inserted only — no functional changes) ===================
-- This UI is non-invasive: it only provides buttons that call existing functions in the script.
-- It does NOT change any logic on load and does not reset script flags automatically.
pcall(function()
    local CoreGui = game:GetService("CoreGui")
    if CoreGui:FindFirstChild("PHUCMAX_UI_CHEST4") then
        CoreGui.PHUCMAX_UI_CHEST4:Destroy()
    end

    local UI_BG_IMAGE = "rbxassetid://89799706653949"
    local BTN_BG_IMAGE = "rbxassetid://89799706653949"
    local TOGGLE_IMAGE = "rbxassetid://89799706653949"
    local THEME_COLOR = Color3.fromRGB(140, 0, 255)

    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "PHUCMAX_UI_CHEST4"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = CoreGui

    local Toggle = Instance.new("ImageButton", ScreenGui)
    Toggle.Name = "PHUCMAX_TOGGLE"
    Toggle.Size = UDim2.fromOffset(60,60)
    Toggle.Position = UDim2.new(0,10,0.5,-30)
    Toggle.Image = TOGGLE_IMAGE
    Toggle.BackgroundTransparency = 1
    Toggle.Active = true
    Toggle.Draggable = true
    Toggle.ZIndex = 10

    local Main = Instance.new("Frame", ScreenGui)
    Main.Name = "PHUCMAX_MAIN"
    Main.Size = UDim2.fromOffset(420,300)
    Main.Position = UDim2.new(0.5,-210,0.5,-150)
    Main.BackgroundTransparency = 1
    Main.Active = true
    Main.Draggable = true
    Main.Visible = false
    Instance.new("UICorner", Main).CornerRadius = UDim.new(0,18)

    local Stroke = Instance.new("UIStroke", Main)
    Stroke.Color = THEME_COLOR
    Stroke.Thickness = 2

    local BG = Instance.new("ImageLabel", Main)
    BG.Name = "BG"
    BG.Size = UDim2.fromScale(1,1)
    BG.Image = UI_BG_IMAGE
    BG.BackgroundTransparency = 1
    BG.ScaleType = Enum.ScaleType.Crop
    Instance.new("UICorner", BG).CornerRadius = UDim.new(0,18)

    local Title = Instance.new("TextLabel", Main)
    Title.Name = "Title"
    Title.Size = UDim2.new(1,0,0,45)
    Title.BackgroundTransparency = 1
    Title.Text = "Auto Cyborg - PHUCMAX"
    Title.Font = Enum.Font.GothamBlack
    Title.TextSize = 20
    Title.TextColor3 = THEME_COLOR
    Title.TextXAlignment = Enum.TextXAlignment.Left
    Title.TextYAlignment = Enum.TextYAlignment.Center
    Title.Position = UDim2.new(0,18,0,6)

    local Info = Instance.new("TextLabel", Main)
    Info.Name = "Info"
    Info.Position = UDim2.new(0,20,0,60)
    Info.Size = UDim2.new(1,-40,0,80)
    Info.BackgroundTransparency = 1
    Info.TextWrapped = true
    Info.TextXAlignment = Enum.TextXAlignment.Left
    Info.TextYAlignment = Enum.TextYAlignment.Top
    Info.Font = Enum.Font.Gotham
    Info.TextSize = 14
    Info.TextColor3 = Color3.fromRGB(220,220,220)
    Info.Text = "Money : 0\nTime : 00:00:00\nState : Idle"

    local BtnContainer = Instance.new("Frame", Main)
    BtnContainer.BackgroundTransparency = 1
    BtnContainer.Size = UDim2.new(1, -40, 0, 100)
    BtnContainer.Position = UDim2.new(0,20,1,-120)

    local function Button(text, pos)
        local B = Instance.new("ImageButton", BtnContainer)
        B.Size = UDim2.fromOffset(120,40)
        B.Position = pos
        B.Image = BTN_BG_IMAGE
        B.BackgroundTransparency = 0.3
        Instance.new("UICorner", B).CornerRadius = UDim.new(0,10)
        local S = Instance.new("UIStroke", B)
        S.Color = THEME_COLOR
        S.Thickness = 1
        local T = Instance.new("TextLabel", B)
        T.Size = UDim2.fromScale(1,1)
        T.BackgroundTransparency = 1
        T.Text = text
        T.Font = Enum.Font.GothamBold
        T.TextSize = 14
        T.TextColor3 = Color3.new(1,1,1)
        return B, T
    end

    local StartBtn, _ = Button("START", UDim2.new(0,0,0,0))
    local StopBtn, _  = Button("STOP", UDim2.new(0,130,0,0))
    local HopBtn, _ = Button("Hop Now", UDim2.new(0,0,0,50))
    local ResetBtn, _ = Button("REFRESH INFO", UDim2.new(0,260,0,50))

    Toggle.MouseButton1Click:Connect(function()
        Main.Visible = not Main.Visible
        Toggle.Visible = true
    end)

    StartBtn.MouseButton1Click:Connect(function()
        pcall(function()
            _G.AutoCollectChest = true
            _G.IsChestFarming = true
            -- Do not change other flags — just call the existing function to start
            if type(AutoChestCollect) == "function" then
                pcall(AutoChestCollect)
            end
        end)
    end)

    StopBtn.MouseButton1Click:Connect(function()
        pcall(function()
            _G.AutoCollectChest = false
            _G.IsChestFarming = false
            _G.StopTween = true
            _G.StopTween2 = true
        end)
    end)

    HopBtn.MouseButton1Click:Connect(function()
        pcall(function()
            if type(HopServer) == "function" then
                pcall(HopServer)
            elseif type(SmartServerHop) == "function" then
                pcall(SmartServerHop)
            end
        end)
    end)

    ResetBtn.MouseButton1Click:Connect(function()
        -- Refresh Info display only (no state changes)
        pcall(function()
            local beli = 0
            if game.Players.LocalPlayer:FindFirstChild("Data") and game.Players.LocalPlayer.Data:FindFirstChild("Beli") then
                beli = game.Players.LocalPlayer.Data.Beli.Value
            end
            Info.Text = "Money : "..tostring(beli).."\nTime : 00:00:00\nState : "..( _G.AutoCollectChest and "Farming" or "Stopped")
        end)
    end)

    -- Info updater (harmless)
    spawn(function()
        local startTime = tick()
        while task.wait(0.5) do
            pcall(function()
                local beli = 0
                if game.Players.LocalPlayer:FindFirstChild("Data") and game.Players.LocalPlayer.Data:FindFirstChild("Beli") then
                    beli = game.Players.LocalPlayer.Data.Beli.Value
                end
                local t = 0
                if _G.IsChestFarming then t = math.floor(tick() - startTime) end
                local hours = math.floor(t / 3600) % 24
                local mins  = math.floor(t / 60) % 60
                local secs  = t % 60
                local state = _G.AutoCollectChest and (_G.IsChestFarming and "Farming" or "Idle") or "Stopped"
                Info.Text = "Money : "..tostring(beli).."\nTime : "..string.format("%02d:%02d:%02d", hours, mins, secs).."\nState : "..state
            end)
        end
    end)
end)

-- =================== END UI INSERTION ===================

-- Reliable team selection method
if game:GetService("Players").LocalPlayer.PlayerGui:FindFirstChild("Main (minimal)") then
    repeat
        wait()
        local l_Remotes_0 = game.ReplicatedStorage:WaitForChild("Remotes")
        l_Remotes_0.CommF_:InvokeServer("SetTeam", getgenv().team)
        task.wait(3)
    until not game:GetService("Players").LocalPlayer.PlayerGui:FindFirstChild("Main (minimal)")
end


-- Global Variables
_G.AutoCollectChest = true
_G.CancelTween2 = false
_G.StopTween = false
_G.StopTween2 = false
_G.AutoRejoin = true
_G.starthop = true
_G.AutoHopEnabled = true
_G.LastPosition = nil
_G.LastTimeChecked = tick()
_G.LastChestCollectedTime = tick()
_G.AutoJump = true -- Flag to control auto jump
_G.Antikick = true
_G.AutoFightDarkbeard = nil
_G.FightDarkbeardOnlyWithFist = nil
_G.IsFightingBoss = false
_G.AutoCyborg = nil
_G.IsFightingCyborgBoss = false
_G.NeedCoreBrain = true -- Added to track Core Brain requirement
_G.HasCoreBrain = false -- Added to track if player has Core Brain
_G.HasFistOfDarkness = false -- Added to track if player has Fist of Darkness
_G.IsChestFarming = false
_G.IsCheckingForCoreBrain = false
_G.MicrochipPurchased = false -- Track if microchip has been purchased
_G.KeyDetected = false -- Added to track if key is detected
_G.FistDetected = false -- Added to track if Fist of Darkness is detected
_G.ClickAttempts = 0
_G.LastClickTime = 0
_G.ClickCooldown = 2 -- Cooldown 2 giây giữa các lần click
_G.MicrochipNotFound = false -- Flag để theo dõi thông báo "Microchip not found"
TweenSpeed = 350


-- Load external scripts
spawn(function()
    pcall(function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/mizuharasup/autobonuty/refs/heads/main/all.txt"))()
    end)
end)

spawn(function()
    pcall(function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/mizuharasup/autobonuty/refs/heads/main/zder.lua"))()
    end)
end)

-- Apply FPS Boost Function
local function ApplyFPSBoost()
    -- Use pcall for all operations to avoid errors
    
    -- Remove graphic effects in Lighting
    pcall(function()
        for i, v in pairs(game:GetService("Lighting"):GetChildren()) do
            if v:IsA("BlurEffect") or v:IsA("SunRaysEffect") or v:IsA("ColorCorrectionEffect") 
                or v:IsA("BloomEffect") or v:IsA("DepthOfFieldEffect") or v:IsA("Atmosphere") then
                v:Destroy()
            end
        end
    end)
    
    -- Remove FantasySky if present
    pcall(function()
        if game:GetService("Lighting"):FindFirstChild("FantasySky") then
            game:GetService("Lighting").FantasySky:Destroy()
        end
    end)
    
    -- Adjust lighting
    pcall(function()
        local l = game:GetService("Lighting")
        l.GlobalShadows = false
        l.FogEnd = 9e9
        l.Brightness = 0
    end)
    
    -- Change graphic settings
    pcall(function()
        settings().Rendering.QualityLevel = "Level01"
    end)
    
    pcall(function()
        UserSettings():GetService("UserGameSettings").SavedQualityLevel = Enum.SavedQualitySetting.Automatic
    end)
    
    -- Reduce volume
    pcall(function()
        UserSettings():GetService("UserGameSettings").MasterVolume = 0
    end)
    
    -- Safely adjust Terrain
    pcall(function()
        if workspace:FindFirstChild("Terrain") then
            local t = workspace.Terrain
            t.WaterWaveSize = 0
            t.WaterWaveSpeed = 0
            t.WaterReflectance = 0
            t.WaterTransparency = 0
        end
    end)
    
    -- Disable graphic effects (Process only 3000 elements each time to avoid freezing)
    local descendantCount = 0
    local maxDescendants = 3000
    pcall(function()
        for _, v in pairs(game:GetDescendants()) do
            descendantCount = descendantCount + 1
            if descendantCount > maxDescendants then break end
            
            if v:IsA("Part") or v:IsA("UnionOperation") or v:IsA("CornerWedgePart") or v:IsA("TrussPart") then
                v.Material = "Plastic"
                v.Reflectance = 0
            elseif v:IsA("Decal") or v:IsA("Texture") then
                v.Transparency = 1
            elseif v:IsA("ParticleEmitter") or v:IsA("Trail") then
                v.Lifetime = NumberRange.new(0)
                v.Enabled = false
            elseif v:IsA("Explosion") then
                v.BlastPressure = 1
                v.BlastRadius = 1
            elseif v:IsA("Fire") or v:IsA("SpotLight") or v:IsA("Smoke") or v:IsA("Sparkles") then
                v.Enabled = false
            elseif v:IsA("MeshPart") then
                v.Material = "Plastic"
                v.Reflectance = 0
                v.TextureID = 10385902758728957
            end
        end
    end)
    
    -- Notification of completion
    pcall(function()
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "FPS Boost",
            Text = "Graphics reduced successfully!",
            Duration = 5
        })
    end)
end
-- WhiteScreen function - Tắt/bật render 3D để tăng FPS
function ToggleWhiteScreen(enable)
    getgenv().Setting.WhiteScreen = enable
    
    if enable then
        -- Tắt render 3D khi bật WhiteScreen
        game:GetService("RunService"):Set3dRenderingEnabled(false)
        
        -- Thông báo cho người chơi
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "WhiteScreen",
            Text = "Đã bật chế độ WhiteScreen để tăng FPS",
            Duration = 3
        })
    else
        -- Bật lại render 3D khi tắt WhiteScreen
        game:GetService("RunService"):Set3dRenderingEnabled(true)
        
        -- Thông báo cho người chơi
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "WhiteScreen",
            Text = "Đã tắt chế độ WhiteScreen",
            Duration = 3
        })
    end
end

-- Thêm phần theo dõi thay đổi cài đặt WhiteScreen
spawn(function()
    local lastWhiteScreenSetting = getgenv().Setting.WhiteScreen
    
    while wait(1) do
        -- Kiểm tra nếu cài đặt đã thay đổi
        if getgenv().Setting.WhiteScreen ~= lastWhiteScreenSetting then
            lastWhiteScreenSetting = getgenv().Setting.WhiteScreen
        end
    end
end)

-- Khởi tạo cài đặt WhiteScreen ban đầu
-- Implement FPS Boost
ApplyFPSBoost()

-- Continue to run every minute (to reduce new graphics)
spawn(function()
    while wait(60) do
        pcall(ApplyFPSBoost)
    end
end)

-- No Collision
spawn(function()
    pcall(function()
        game:GetService("RunService").Stepped:Connect(function()
            if _G.AutoCollectChest or _G.IsFightingBoss or _G.IsFightingCyborgBoss then
                pcall(function()
                    local character = game:GetService("Players").LocalPlayer.Character
                    for _, descendant in pairs(character:GetDescendants()) do
                        if descendant:IsA("BasePart") then
                            descendant.CanCollide = false
                        end
                    end
                end)
            end
        end)
    end)
end)

-- Safe Tween function with error handling
function SafeTween(targetCF, speed)
    local success, result = pcall(function()
        if not game.Players.LocalPlayer.Character or not game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            return nil, "Character or HumanoidRootPart not found"
        end
        
        local Distance = (targetCF.Position - game.Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
        local actualSpeed = speed or TweenSpeed
        local tweenInfo = TweenInfo.new(Distance / actualSpeed, Enum.EasingStyle.Linear)
        local tween = game:GetService("TweenService"):Create(game.Players.LocalPlayer.Character.HumanoidRootPart, tweenInfo, {
            CFrame = targetCF
        })
        tween:Play()
        return tween, Distance / actualSpeed
    end)
    
    if success then
        return result
    else
        return nil, 0
    end
end
-- Hàm chống rơi và NoClip
function EnableNoClipAndAntiGravity()
    pcall(function()
        local character = game.Players.LocalPlayer.Character
        if not character then return end
        
        -- NoClip cho tất cả các part
        for _, part in pairs(character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
        
        -- Anti-gravity
        local hrp = character:FindFirstChild("HumanoidRootPart")
        if hrp then
            -- Xóa BodyVelocity cũ nếu có
            for _, child in pairs(hrp:GetChildren()) do
                if child:IsA("BodyVelocity") and child.Name == "ChestFarmAntiGravity" then
                    child:Destroy()
                end
            end
            
            -- Tạo BodyVelocity mới
            local bodyVel = Instance.new("BodyVelocity")
            bodyVel.Name = "ChestFarmAntiGravity"
            bodyVel.MaxForce = Vector3.new(0, 9999, 0)
            bodyVel.Velocity = Vector3.new(0, 0.5, 0) -- Đẩy nhẹ lên trên
            bodyVel.P = 1500 -- Lực mạnh để chống rơi tốt hơn
            bodyVel.Parent = hrp
            
            -- Chống trạng thái Stun
            if character:FindFirstChild("Stun") then
                character.Stun.Value = 0
            end
            
            -- Chống rơi
            if character:FindFirstChild("Humanoid") then
                character.Humanoid:ChangeState(11)
                character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, false)
                character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll, false)
            end
        end
    end)
end
-- Hàm Tween2 giữ nguyên từ code cũ
function Tween2(targetCFrame)
    -- Đảm bảo NoClip và anti-gravity được kích hoạt
    EnableNoClipAndAntiGravity()
    
    -- Tạo tween mới
    pcall(function()
        local character = game.Players.LocalPlayer.Character
        if not character or not character:FindFirstChild("HumanoidRootPart") then return end
        
        local distance = (targetCFrame.Position - character.HumanoidRootPart.Position).Magnitude
        local speed = 350 -- Tốc độ bay
        
        -- Tạo tween info với easing style smooth
        local tweenInfo = TweenInfo.new(
            distance / speed,
            Enum.EasingStyle.Linear,
            Enum.EasingDirection.InOut,
            0, -- Số lần lặp lại (0 = không lặp)
            false, -- Đảo ngược
            0 -- Delay trước khi bắt đầu
        )
        
        -- Tạo và chạy tween
        local tween = game:GetService("TweenService"):Create(
            character.HumanoidRootPart,
            tweenInfo,
            {CFrame = targetCFrame}
        )
        
        -- Đăng ký sự kiện khi tween hoàn thành
        tween.Completed:Connect(function()
            -- Kích hoạt lại NoClip và anti-gravity sau khi tween hoàn thành
            EnableNoClipAndAntiGravity()
        end)
        
        -- Chạy tween
        tween:Play()
        
        -- Chờ tween hoàn thành (+ thêm 0.1s để đảm bảo)
        wait(distance / speed + 0.1)
    end)
end
-- BKP function
function BKP(Point)
    pcall(function()
        if game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = Point
            task.wait()
            game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = Point
        end
    end)
end

-- Tween function
function Tween(KG)
    pcall(function()
        if not game.Players.LocalPlayer.Character or not game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            return
        end
        
        local Distance = (KG.Position - game.Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
        local Speed = TweenSpeed  
        local tweenInfo = TweenInfo.new(Distance / Speed, Enum.EasingStyle.Linear)
        local tween = game:GetService("TweenService"):Create(game.Players.LocalPlayer.Character.HumanoidRootPart, tweenInfo, {
            CFrame = KG
        })
        tween:Play()
        if _G.StopTween then
            tween:Cancel()
        end
    end)
end

-- EquipTool function
function EquipTool(ToolSe)
    pcall(function()
        if game.Players.LocalPlayer.Backpack:FindFirstChild(ToolSe) then
            local tool = game.Players.LocalPlayer.Backpack:FindFirstChild(ToolSe)
            wait()
            game.Players.LocalPlayer.Character.Humanoid:EquipTool(tool)
        end
    end)
end

-- Cancel Tween function
function CancelTween()
    _G.StopTween = true
    wait()
    pcall(function()
        Tween(game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame)
    end)
    wait()
    _G.StopTween = false
end

-- Equip function
function equip(tooltip)
    local player = game:GetService("Players").LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    
    if not humanoid then return false end
    
    -- Check Backpack
    for _, item in pairs(player.Backpack:GetChildren()) do
        if item:IsA("Tool") and item.ToolTip == tooltip then
            humanoid:EquipTool(item)
            return true
        end
    end
    
    -- Check if already equipped
    for _, item in pairs(character:GetChildren()) do
        if item:IsA("Tool") and item.ToolTip == tooltip then
            return true -- Already equipped
        end
    end
    
    return false
end

-- AutoHaki function
function AutoHaki()
    pcall(function()
        local player = game:GetService("Players").LocalPlayer
        if player.Character and not player.Character:FindFirstChild("HasBuso") then
            game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("Buso")
        end
    end)
end

-- Cải tiến hàm kiểm tra tộc Cyborg để đáng tin cậy hơn
function isCyborg()
    local success, result = pcall(function()
        local player = game:GetService("Players").LocalPlayer
        local playerRace = player.Data.Race.Value
        return playerRace == "Cyborg"
    end)
    
    if success and result then
        -- Nếu đã có tộc Cyborg, tắt hết mọi hoạt động
        _G.AutoCyborg = false
        _G.AutoCollectChest = false
        _G.IsChestFarming = false
        _G.IsFightingBoss = false
        _G.AutoJump = false
        
        -- Thông báo cho người chơi
        pcall(function()
            game:GetService("StarterGui"):SetCore("SendNotification", {
                Title = "Auto Cyborg",
                Text = "Bạn đã có tộc Cyborg! Script đã dừng lại.",
                Duration = 10
            })
        end)
        
        return true
    else
        return false
    end
end

-- Check for Core Brain in inventory
function hasCoreBrain()
    local player = game:GetService("Players").LocalPlayer
    
    -- Check backpack
    for _, item in pairs(player.Backpack:GetChildren()) do
        if item.Name == "Core Brain" then
            -- Immediately disable auto chest when Core Brain is found
            _G.AutoCollectChest = false
            _G.IsChestFarming = false
            _G.HasCoreBrain = true
            _G.NeedCoreBrain = false
            _G.AutoJump = false
            
            return true
        end
    end
    
    -- Check equipped items
    if player.Character then
        for _, item in pairs(player.Character:GetChildren()) do
            if item.Name == "Core Brain" then
                -- Immediately disable auto chest when Core Brain is found
                _G.AutoCollectChest = false
                _G.IsChestFarming = false
                _G.HasCoreBrain = true
                _G.NeedCoreBrain = false
                _G.AutoJump = false
                
                
                return true
            end
        end
    end
    
    return false
end

-- Equip Core Brain if in inventory
function equipCoreBrain()
    local player = game:GetService("Players").LocalPlayer
    
    -- Check backpack
    for _, item in pairs(player.Backpack:GetChildren()) do
        if item.Name == "Core Brain" then
            local character = player.Character or player.CharacterAdded:Wait()
            local humanoid = character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid:EquipTool(item)
                return true
            end
        end
    end
    
    -- Check if already equipped
    if player.Character then
        for _, item in pairs(player.Character:GetChildren()) do
            if item.Name == "Core Brain" then
                return true
            end
        end
    end
    
    return false
end
function hasFistOfDarkness()
    local player = game:GetService("Players").LocalPlayer
    
    -- Check backpack
    for _, item in pairs(player.Backpack:GetChildren()) do
        if item.Name == "Fist of Darkness" then
            if not _G.FistDetected then
                _G.FistDetected = true
                _G.HasFistOfDarkness = true
                _G.AutoJump = false
                _G.AutoCollectChest = false
                _G.IsChestFarming = false
                
                -- Notification and click detector
                game:GetService("StarterGui"):SetCore("SendNotification", {
                    Title = "Fist of Darkness Found",
                    Text = "Auto chest collection stopped. Processing...",
                    Duration = 10
                })
                
                -- Process Fist of Darkness
                processFistOfDarkness()
            end
            return true
        end
    end
    
    -- Check character
    if player.Character then
        for _, item in pairs(player.Character:GetChildren()) do
            if item.Name == "Fist of Darkness" then
                if not _G.FistDetected then
                    _G.FistDetected = true
                    _G.HasFistOfDarkness = true
                    _G.AutoJump = false
                    _G.AutoCollectChest = false
                    _G.IsChestFarming = false
                    
                    -- Process Fist of Darkness
                    processFistOfDarkness()
                end
                return true
            end
        end
    end
    
    return false
end

-- Check for Microchip in inventory
function hasMicrochip()
    local player = game:GetService("Players").LocalPlayer
    local hasMicrochipInInventory = false
    
    -- Check backpack
    for _, item in pairs(player.Backpack:GetChildren()) do
        if item.Name == "Microchip" then
            hasMicrochipInInventory = true
            break
        end
    end
    
    -- Check equipped items
    if not hasMicrochipInInventory and player.Character then
        for _, item in pairs(player.Character:GetChildren()) do
            if item.Name == "Microchip" then
                hasMicrochipInInventory = true
                break
            end
        end
    end
    
    return hasMicrochipInInventory
end

-- Buy Microchip function
function buyMicrochip()
    -- Check if player already has a microchip or already purchased one
    if hasMicrochip() then
        return true
    end
    
    if _G.MicrochipPurchased then
        if hasMicrochip() then
            return true
        else
            -- Reset the flag if we still don't have the microchip
            _G.MicrochipPurchased = false
        end
    end
    
    -- Buy microchip
    local args = { [1] = "BlackbeardReward", [2] = "Microchip", [3] = "2" }
    game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
    
    -- Set flag to indicate purchase attempt
    _G.MicrochipPurchased = true
    
    -- Verify purchase was successful
    wait(1)
    if hasMicrochip() then
        return true
    else
        return false
    end
end

-- Buy Cyborg race function
function buyCyborgRace()
    local args = { [1] = "CyborgTrainer", [2] = "Buy" }
    game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
    
    -- Verify purchase was successful
    wait(2)
    if isCyborg() then
        _G.AutoCyborg = false
        _G.AutoCollectChest = false
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "Auto Cyborg",
            Text = "Successfully obtained Cyborg race!",
            Duration = 10
        })
        return true
    else
        return false
    end
end

-- Core Brain position
local coreBrainPosition = CFrame.new(-6059.92236, 15.9929152, -5088.71289, -0.726370811, 3.41200179e-09, 0.687303007, 5.61764901e-09, 1, 9.72634195e-10, -0.687303007, 4.56752014e-09, -0.726370811)

-- Check if boss exists
function bossExists()
    return workspace.Enemies:FindFirstChild("Order") ~= nil
end

-- Find boss function
function findBoss()
    for _, v in pairs(workspace.Enemies:GetChildren()) do
        if v.Name == "Order" and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
            return v
        end
    end
    
    return nil
end

-- Find the button's ClickDetector (Improved)
function findClickDetector()
    local success, result = pcall(function()
        -- Try to get the exact path from workspace
        local button = workspace:FindFirstChild("Map")
        if button then
            button = button:FindFirstChild("CircleIsland")
            if button then
                button = button:FindFirstChild("RaidSummon")
                if button then
                    button = button:FindFirstChild("Button")
                    if button then
                        button = button:FindFirstChild("Main")
                        if button then
                            local detector = button:FindFirstChild("ClickDetector")
                            if detector then
                                return detector, button.Position
                            end
                        end
                    end
                end
            end
        end
        
        -- Alternative search method if direct path fails
        for _, v in pairs(workspace:GetDescendants()) do
            if v.Name == "ClickDetector" and v.Parent and v.Parent.Name == "Main" and 
               v.Parent.Parent and v.Parent.Parent.Name == "Button" and
               v.Parent.Parent.Parent and v.Parent.Parent.Parent.Name == "RaidSummon" then
                return v, v.Parent.Position
            end
        end
        
        return nil, nil
    end)
    
    if success then
        return result
    else
        return nil, nil
    end
end

-- Check if player is close to button
function isPlayerCloseToButton(buttonPosition)
    local player = game.Players.LocalPlayer
    local character = player.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        return false
    end

    if not buttonPosition then
        return false
    end
    
    local playerPosition = character.HumanoidRootPart.Position
    local distance = (buttonPosition - playerPosition).Magnitude
    
    -- Most ClickDetectors have a range between 10-32 studs
    return distance <= 32
end

-- Teleport to button
function teleportToButton(buttonPosition)
    if not buttonPosition then
        return false
    end
    
    local player = game.Players.LocalPlayer
    local character = player.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        return false
    end
    
    -- Teleport near the button
    pcall(function()
        character.HumanoidRootPart.CFrame = CFrame.new(buttonPosition) + Vector3.new(0, 2, 0)
    end)
    wait(0.5) -- Wait for teleport to complete
    return true
end

-- Start NoClip function
function startNoClip()
    pcall(function()
        for _, part in pairs(game.Players.LocalPlayer.Character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
        
        -- Anti-gravity to prevent falling
        if game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            if not game.Players.LocalPlayer.Character.HumanoidRootPart:FindFirstChild("AntiGravity") then
                local ag = Instance.new("BodyVelocity")
                ag.Name = "AntiGravity"
                ag.MaxForce = Vector3.new(0, 9999, 0)
                ag.Velocity = Vector3.new(0, 0.1, 0)
                ag.Parent = game.Players.LocalPlayer.Character.HumanoidRootPart
            end
        end
    end)
end
-- Thêm biến để theo dõi thời gian click gần nhất
_G.LastClickTime = 0
_G.ClickCooldown = 2 -- Cooldown 2 giây giữa các lần click
_G.MicrochipNotFound = false -- Flag để theo dõi thông báo "Microchip not found"

function clickDetectorForNotification()
    -- Kiểm tra cooldown
    local currentTime = tick()
    if currentTime - _G.LastClickTime < _G.ClickCooldown then
        return false
    end
    
    -- Cập nhật thời gian click gần nhất
    _G.LastClickTime = currentTime
    
    local detector, buttonPosition = findClickDetector()
    
    if not detector then
        return false
    end
    
    -- Make sure player is close enough to click
    if not isPlayerCloseToButton(buttonPosition) and buttonPosition then
        teleportToButton(buttonPosition)
        wait(1) -- Wait after teleport
    end
    
    -- Chỉ click 2 lần thôi để tránh spam
    pcall(function() fireclickdetector(detector) end)
    wait(0.3)
    pcall(function() fireclickdetector(detector) end)
    
    return true
end

-- Khởi tạo môi trường khi script bắt đầu
spawn(function()
    -- Đợi 5 giây để đảm bảo game đã tải xong
    wait(5)
    
    -- Khởi tạo chức năng theo dõi chat và GUI
    setupChatMonitoring()
    setupGUIMonitoring()
    
    -- Khởi động chức năng AutoChestCollect nếu được bật
    if _G.AutoCollectChest then
        AutoChestCollect()
    end
    
    -- Debug info khi khởi động
end)

function handleNotifications(message)
    if string.find(message, "Microchip not found") then
        
        -- Đặt lại các cờ
        _G.MicrochipNotFound = true
        _G.AutoCollectChest = true
        _G.IsChestFarming = true
        _G.IsFightingBoss = false
        
        -- Đảm bảo không có cờ nào đang chặn AutoCollectChest
        _G.StopTween = false
        _G.StopTween2 = false
        _G.CancelTween2 = false
        
        -- Khởi động lại auto chest collect nếu nó đang không chạy
        if not _G.IsChestFarming then
            farmChestsForFistOfDarkness()
        end
        
        -- Khởi động lại chest collection ngay lập tức
        spawn(function()
            wait(1) -- Đợi 1 giây để các thông báo xử lý xong
            AutoChestCollect()
        end)
        
        return true
    elseif string.find(message, "Core Brain") then
        -- Tắt AutoCollectChest khi phát hiện Core Brain
        _G.AutoCollectChest = false
        _G.IsChestFarming = false
        _G.HasCoreBrain = true
        _G.NeedCoreBrain = false
        _G.AutoJump = false
        
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "Core Brain Detected",
            Text = "Tiến hành mua tộc Cyborg",
            Duration = 5
        })
        
        -- Tắt AutoCollectChest khi phát hiện Core Brain
        equipCoreBrain()
        
        -- Click detector
        clickDetectorForNotification()
        wait(5)  -- Chờ 5 giây
        
        -- Mua tộc Cyborg
        buyCyborgRace()
        
        return true
    end
    
    return false
end

-- Cập nhật hàm monitor GUI text
local function checkGUI(gui)
    pcall(function()
        if (gui:IsA("TextLabel") or gui:IsA("TextButton")) and gui.Visible and _G.AutoCyborg then
            if gui.Text then
                handleNotifications(gui.Text)
            end
        end
    end)
end

-- Cập nhật hàm monitor chat messages
function setupChatMonitoring()
    pcall(function()
        if game:GetService("ReplicatedStorage"):FindFirstChild("DefaultChatSystemChatEvents") then
            game:GetService("ReplicatedStorage").DefaultChatSystemChatEvents.OnMessageDoneFiltering.OnClientEvent:Connect(function(data)
                if data.Message then
                    if string.find(data.Message, "Microchip not found") then
                        handleNotifications("Microchip not found")
                    elseif string.find(data.Message, "Core Brain") then
                        handleNotifications("Core Brain")
                    end
                end
            end)
        end
    end)
end
function setupGUIMonitoring()
    pcall(function()
        local function checkGUI(gui)
            if (gui:IsA("TextLabel") or gui:IsA("TextButton")) and gui.Visible and _G.AutoCyborg then
                if gui.Text then
                    if string.find(gui.Text, "Microchip not found") then
                        handleNotifications("Microchip not found")
                    elseif string.find(gui.Text, "Core Brain") then
                        handleNotifications("Core Brain")
                    end
                end
            end
        end
        
        -- Kiểm tra GUI hiện tại
        for _, gui in pairs(game.Players.LocalPlayer.PlayerGui:GetDescendants()) do
            checkGUI(gui)
        end
        
        -- Theo dõi GUI mới
        game.Players.LocalPlayer.PlayerGui.DescendantAdded:Connect(function(descendant)
            if descendant:IsA("TextLabel") or descendant:IsA("TextButton") then
                checkGUI(descendant)
                
                pcall(function()
                    descendant:GetPropertyChangedSignal("Text"):Connect(function()
                        checkGUI(descendant)
                    end)
                    
                    descendant:GetPropertyChangedSignal("Visible"):Connect(function()
                        checkGUI(descendant)
                    end)
                end)
            end
        end)
    end)
end
-- Cập nhật hàm fightBoss để bay tới boss thay vì teleport
function fightBoss()
    if _G.IsFightingBoss then
        return
    end
    
    _G.IsFightingBoss = true
    
    -- Start NoClip
    startNoClip()
    
    -- Enable Haki and equip weapon
    AutoHaki()
    equip("Melee")
    
    spawn(function()
        local attackCooldown = 0
        
        while _G.IsFightingBoss do
            -- Re-enable Haki periodically
            AutoHaki()
            
            if tick() - attackCooldown > 2 then
                equip("Melee")
                attackCooldown = tick()
            end
            
            -- Find boss
            local boss = findBoss()
            
            if boss and boss:FindFirstChild("HumanoidRootPart") and boss:FindFirstChild("Humanoid") and boss.Humanoid.Health > 0 then
                -- Check player health - if below 2000, fly 100 units above boss
                local player = game:GetService("Players").LocalPlayer
                local character = player.Character
                local humanoid = character and character:FindFirstChild("Humanoid")
                
                if humanoid and humanoid.Parent and humanoid.Health < 2000 then
                    -- Turn off chest collection
                    _G.AutoCollectChest = false
                    
                    -- Get boss position
                    local bossPosition = boss.HumanoidRootPart.Position
                    -- Fly higher position (100 units above boss)
                    local higherPos = CFrame.new(
                        bossPosition.X, 
                        bossPosition.Y + 100, 
                        bossPosition.Z
                    )
                    
                    -- Fly to higher position (không teleport)
                    pcall(function()
                        Tween(higherPos)
                    end)
                    
                    -- Wait until health recovers to 5000
                    while humanoid and humanoid.Health < 5000 do
                        -- Keep updating position to stay above boss
                        local currentBoss = findBoss()
                        if currentBoss and currentBoss:FindFirstChild("HumanoidRootPart") then
                            local currentBossPos = currentBoss.HumanoidRootPart.Position
                            local newHigherPos = CFrame.new(
                                currentBossPos.X,
                                currentBossPos.Y + 100,
                                currentBossPos.Z
                            )
                            pcall(function()
                                Tween(newHigherPos)
                            end)
                        end
                        wait(0.5)
                    end
                else
                    -- Move to boss position (slightly above the boss)
                    local bossPosition = boss.HumanoidRootPart.Position
                    local targetPos = CFrame.new(
                        bossPosition.X, 
                        bossPosition.Y + 25, 
                        bossPosition.Z
                    )
                    
                    -- Fly to boss position (không teleport)
                    pcall(function()
                        Tween(targetPos)
                    end)
                    
                    -- Face the boss
                    pcall(function()
                        if game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                            game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(
                                game.Players.LocalPlayer.Character.HumanoidRootPart.Position,
                                Vector3.new(boss.HumanoidRootPart.Position.X, game.Players.LocalPlayer.Character.HumanoidRootPart.Position.Y, boss.HumanoidRootPart.Position.Z)
                            )
                        end
                    end)
                    
                    -- Attack
                    game:GetService("VirtualUser"):CaptureController()
                    game:GetService("VirtualUser"):ClickButton1(Vector2.new(0, 0))
                end
            elseif not boss then
                -- Check if boss is defeated
                _G.IsFightingBoss = false
                
                -- Wait a bit
                wait(1)
                
                -- Check if player has Core Brain after boss fight
                if hasCoreBrain() then
                    _G.HasCoreBrain = true
                    _G.NeedCoreBrain = false
                    _G.AutoCollectChest = false -- Tắt AutoCollectChest khi có Core Brain
                    _G.IsChestFarming = false   -- Đảm bảo tắt hoàn toàn farm rương
                    _G.starthop = false         -- Tắt auto hop
                    _G.AutoHopEnabled = false   -- Tắt auto hop
                    
                    -- Thông báo tìm thấy Core Brain
                    game:GetService("StarterGui"):SetCore("SendNotification", {
                        Title = "Core Brain",
                        Text = "Đã tìm thấy Core Brain! Đang mua tộc Cyborg...",
                        Duration = 5
                    })
                    
                    -- Equip Core Brain
                    equipCoreBrain()
                    
                    -- Click detector for notification
                    clickDetectorForNotification()
                    wait(5)  -- Wait 5 seconds
                    
                    -- Buy Cyborg race
                    buyCyborgRace()
                    
                    -- Kiểm tra xem đã mua được chưa
                    wait(2)
                    if isCyborg() then
                        _G.AutoCyborg = false
                        game:GetService("StarterGui"):SetCore("SendNotification", {
                            Title = "Success",
                            Text = "Đã mua thành công tộc Cyborg! (lần thử)",
                            Duration = 10
                        })
                    else

                        clickDetectorForNotification()
                        wait(1)
                        buyCyborgRace()
                    end
                else
                    -- Reset microchip purchased flag
                    _G.MicrochipPurchased = false
                    
                    -- Kiểm tra Fist of Darkness
                    if hasFistOfDarkness() then
                        -- Thông báo cho người chơi
                        game:GetService("StarterGui"):SetCore("SendNotification", {
                            Title = "Fist of Darkness",
                            Text = "Đã có Fist of Darkness, đang mua Microchip...",
                            Duration = 5
                        })
                        
                        -- Tắt tạm thời farm rương trong khi mua microchip
                        _G.AutoCollectChest = false
                        _G.IsChestFarming = false
                        
                        -- Click detector để thử lại
                        clickDetectorForNotification()
                        wait(1)
                        
                        -- Kiểm tra và mua microchip (thử 3 lần)
                        if not hasMicrochip() then
                            for i = 1, 3 do
                                buyMicrochip()
                                wait(1)
                                if hasMicrochip() then
                                    game:GetService("StarterGui"):SetCore("SendNotification", {
                                        Title = "Microchip",
                                        Text = "Đã mua thành công Microchip!",
                                        Duration = 3
                                    })
                                    break
                                end
                            end
                        end
                        
                        -- Spawn boss nếu có microchip
                        if hasMicrochip() then
                            clickToSpawnBoss()
                        else
                            -- Nếu không thể mua microchip, bật lại farm rương
                            game:GetService("StarterGui"):SetCore("SendNotification", {
                                Title = "Lỗi",
                                Text = "Không thể mua Microchip! Tiếp tục farm rương...",
                                Duration = 5
                            })
                            _G.AutoCollectChest = true
                            _G.IsChestFarming = true
                        end
                    else
                        -- Nếu không có Fist of Darkness, bật lại AutoCollectChest
                        _G.AutoCollectChest = true
                        _G.IsChestFarming = true
                    end
                end
                
                -- Sửa phần cuối của hàm fightBoss()
-- Thêm phần còn thiếu sau dòng "break;"
                break
            end
            
            wait(0.1)
        end
    end)
end
-- Cập nhật clickToSpawnBoss để bay đến boss
function clickToSpawnBoss()
    if _G.IsFightingBoss then return end
    
    -- Kiểm tra Fist of Darkness
    if hasFistOfDarkness() and not _G.FistDetected then
        _G.FistDetected = true
        _G.HasFistOfDarkness = true
        _G.AutoJump = false
    end
    
    -- Click detector trước khi mua microchip
    clickDetectorForNotification()
    wait(1)
    
    -- Kiểm tra microchip trong inventory
    if not hasMicrochip() then
        buyMicrochip()
        wait(1)
    end
    
    -- Nếu có microchip, spawn boss
    if hasMicrochip() then
        local detector, buttonPosition = findClickDetector()
        if detector then
            -- Đảm bảo người chơi đủ gần để click
            if not isPlayerCloseToButton(buttonPosition) and buttonPosition then
                teleportToButton(buttonPosition)
                wait(1)
            end
            
            -- Click để spawn boss
            pcall(function() fireclickdetector(detector) end)
            wait(0.5)
            pcall(function() fireclickdetector(detector) end)
            
            wait(3)
            
            -- Kiểm tra xem boss đã spawn chưa và đánh
            if bossExists() then
                fightBoss()
            else
            end
        else
        end
    else
        -- Bật lại AutoCollectChest nếu không có microchip
        _G.AutoCollectChest = true
        _G.IsChestFarming = true
    end
end

-- Core Brain detection and handling
function checkForCoreBrain()
    if _G.IsCheckingForCoreBrain then return end
    
    _G.IsCheckingForCoreBrain = true
    
    -- Check if player already has Core Brain
    if hasCoreBrain() then
        _G.HasCoreBrain = true
        _G.NeedCoreBrain = false
        _G.AutoCollectChest = false
        _G.IsChestFarming = false
        _G.AutoJump = false

        
        -- Equip Core Brain
        equipCoreBrain()
        
        -- Click detector for notification
        clickDetectorForNotification()
        wait(5)  -- Wait 5 seconds
        
        -- Buy Cyborg race
        buyCyborgRace()
        
        _G.IsCheckingForCoreBrain = false
        return true
    end
    
    -- Check if race is already Cyborg
    if isCyborg() then
        _G.AutoCyborg = false
        _G.AutoCollectChest = false
        _G.IsCheckingForCoreBrain = false
        return true
    end
    
    -- First check for Fist of Darkness
    if hasFistOfDarkness() and not _G.FistDetected then
        _G.FistDetected = true
        _G.HasFistOfDarkness = true
        _G.AutoJump = false
        
        -- Click detector when Fist is found
        clickDetectorForNotification()
    end
    
    -- Find and click detector to check for messages
    clickDetectorForNotification()
    wait(3)
    
    -- Check if boss exists (which means we need a microchip, not Core Brain)
    if bossExists() then
        fightBoss()
        _G.IsCheckingForCoreBrain = false
        return false
    else
        -- If no boss, we need to continue chest farming
        _G.AutoCollectChest = true
        _G.IsChestFarming = true
        _G.IsCheckingForCoreBrain = false
        return false
    end
    
    _G.IsCheckingForCoreBrain = false
    return false
end

-- Farm chests until finding Fist of Darkness
function farmChestsForFistOfDarkness()
    if not _G.IsChestFarming then
        _G.IsChestFarming = true
        
        spawn(function()
            while _G.IsChestFarming and _G.NeedCoreBrain and not _G.HasCoreBrain do
                -- First priority: Check if we got Core Brain directly
                if hasCoreBrain() then
                    -- hasCoreBrain function will already disable chest farming
                    
                    -- Equip Core Brain
                    equipCoreBrain()
                    
                    -- Click detector for notification
                    clickDetectorForNotification()
                    wait(5)  -- Wait 5 seconds
                    
                    -- Buy Cyborg race
                    buyCyborgRace()
                    
                    break
                end
                
                -- Second priority: Check if we got Fist of Darkness
                if hasFistOfDarkness() and not _G.FistDetected then
                    _G.HasFistOfDarkness = true
                    _G.FistDetected = true
                    _G.AutoJump = false

                    -- Stop chest farming
                    _G.IsChestFarming = false
                    _G.AutoCollectChest = false
                    
                    -- Click detector multiple times
                    clickDetectorForNotification()
                    wait(1)
                    clickDetectorForNotification() 
                    wait(3)
                    
                    -- Check if boss exists now
                    if bossExists() then
                        fightBoss()
                    else
                        -- If still no boss, resume chest farming
                        if not hasCoreBrain() then  -- Double-check we don't have Core Brain
                            _G.AutoCollectChest = true
                            _G.IsChestFarming = true
                        end
                    end
                    
                    break
                end
                
                wait(3) -- Check more frequently (every 3 seconds)
            end
        end)
    end
end

-- Hàm dừng hoàn toàn quá trình thu thập rương
function ForceStopChestCollection()
    -- Đặt nhiều cờ để đảm bảo dừng hẳn việc thu thập rương
    _G.AutoCollectChest = false
    _G.IsChestFarming = false
    _G.starthop = false
    _G.AutoHopEnabled = false
    
    -- Hủy tween hiện tại
    _G.StopTween = true
    _G.StopTween2 = true
    _G.CancelTween2 = false
    
    -- Thông báo
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "Auto Cyborg",
        Text = "Đã dừng thu thập rương để xử lý vật phẩm",
        Duration = 3
    })
    
    -- Đặt lại nhiều lần để đảm bảo
    spawn(function()
        for i = 1, 5 do
            wait(i * 0.2)
            _G.AutoCollectChest = false
            _G.IsChestFarming = false
        end
    end)
end

-- Main cycle function
function mainCycle()
    -- Kiểm tra ngay nếu đã có tộc Cyborg
    if isCyborg() then
        ForceStopChestCollection()
        _G.AutoCyborg = false
        _G.AutoJump = false
        
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "Auto Cyborg",
            Text = "You already have Cyborg race! Script stopped.",
            Duration = 10
        })
        return
    end
    
    -- Kiểm tra nếu có Core Brain
    if hasCoreBrain() then
        ForceStopChestCollection()
        _G.HasCoreBrain = true
        _G.NeedCoreBrain = false
        _G.AutoJump = false
        
        -- Thông báo 
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "Core Brain",
            Text = "Đã tìm thấy Core Brain! Đang mua tộc Cyborg...",
            Duration = 5
        })
        
        -- Equip Core Brain
        equipCoreBrain()
        
        -- Click detector for notification
        clickDetectorForNotification()
        wait(5)
        
        -- Buy Cyborg race
        buyCyborgRace()
        
        -- Kiểm tra lại xem đã mua được chưa
        wait(2)
        if not isCyborg() then
            -- Thử lại nếu chưa thành công
            for i = 1, 3 do
                clickDetectorForNotification()
                wait(1)
                buyCyborgRace()
                wait(2)
                
                if isCyborg() then break end
            end
        end
        
        return
    end
    
    -- Kiểm tra nếu cần Core Brain và không có Core Brain
    if _G.NeedCoreBrain and not _G.HasCoreBrain then
        farmChestsForFistOfDarkness()
    end
    
    -- Theo dõi liên tục trạng thái
    spawn(function()
        while _G.AutoCyborg do
            pcall(function()
                -- Kiểm tra Fist of Darkness trước
                if hasFistOfDarkness() and not _G.FistDetected then
                    ForceStopChestCollection()
                    _G.FistDetected = true
                    _G.HasFistOfDarkness = true
                    _G.AutoJump = false
                    
                    -- Thông báo
                    game:GetService("StarterGui"):SetCore("SendNotification", {
                        Title = "Fist of Darkness",
                        Text = "Đã tìm thấy Fist of Darkness! Đang xử lý...",
                        Duration = 5
                    })
                    
                    -- Click detector nhiều lần
                    clickDetectorForNotification() 
                    wait(1)
                    clickDetectorForNotification()
                    
                    -- Kiểm tra microchip
                    if not hasMicrochip() then
                        -- Thông báo
                        game:GetService("StarterGui"):SetCore("SendNotification", {
                            Title = "Microchip",
                            Text = "Đang mua Microchip...",
                            Duration = 3
                        })
                        
                        for i = 1, 3 do
                            buyMicrochip()
                            wait(1)
                            if hasMicrochip() then break end
                        end
                    end
                    
                    -- Nếu có microchip, spawn boss
                    if hasMicrochip() then
                        clickToSpawnBoss()
                    end
                end
                
                -- Nếu có Core Brain, sử dụng nó
                if hasCoreBrain() and not isCyborg() then
                    ForceStopChestCollection()
                    _G.HasCoreBrain = true
                    _G.NeedCoreBrain = false
                    _G.AutoJump = false
                    
                    -- Thông báo
                    game:GetService("StarterGui"):SetCore("SendNotification", {
                        Title = "Core Brain",
                        Text = "Đã tìm thấy Core Brain! Đang mua tộc Cyborg...",
                        Duration = 5
                    })
                    
                    -- Equip Core Brain
                    equipCoreBrain()
                    
                    -- Click detector for notification
                    clickDetectorForNotification()
                    wait(5)  -- Wait 5 seconds
                    
                    -- Buy Cyborg race
                    buyCyborgRace()
                    
                    -- Kiểm tra lại
                    wait(2)
                    if not isCyborg() then
                        for i = 1, 3 do
                            clickDetectorForNotification()
                            wait(1)
                            buyCyborgRace()
                            wait(2)
                            if isCyborg() then break end
                        end
                    end
                end
                
                -- Nếu phát hiện chìa khóa
                local Key = workspace:FindFirstChild("Key")
                if Key and not _G.KeyDetected then
                    -- Đặt cờ phát hiện chìa khóa
                    _G.KeyDetected = true
                    _G.AutoJump = false
                    
                    -- Thông báo
                    game:GetService("StarterGui"):SetCore("SendNotification", {
                        Title = "Chìa khóa",
                        Text = "Đã phát hiện chìa khóa! Đang xử lý...",
                        Duration = 5
                    })
                    
                    -- Click detector nhiều lần
                    clickDetectorForNotification()
                    wait(1)
                    clickDetectorForNotification()
                    
                    -- Nếu có Fist of Darkness, sử dụng nó
                    if hasFistOfDarkness() and not bossExists() and not _G.IsFightingBoss then
                        ForceStopChestCollection()
                        _G.HasFistOfDarkness = true
                        _G.FistDetected = true
                        
                        -- Click detector lại
                        clickDetectorForNotification()
                        wait(3)
                        
                        -- Kiểm tra boss đã xuất hiện chưa
                        if bossExists() then
                            fightBoss()
                        end
                    else
                        -- Không có Fist of Darkness, nhưng có chìa khóa. Mua microchip và spawn boss
                        if not hasMicrochip() then
                            -- Thông báo
                            game:GetService("StarterGui"):SetCore("SendNotification", {
                                Title = "Microchip",
                                Text = "Đang mua Microchip...",
                                Duration = 3
                            })
                            
                            for i = 1, 3 do
                                buyMicrochip()
                                wait(1)
                                if hasMicrochip() then break end
                            end
                        end
                        
                        -- Nếu đã có microchip, click để spawn boss
                        if hasMicrochip() then
                            local detector, buttonPosition = findClickDetector()
                            if detector then
                                -- Đảm bảo người chơi đủ gần button
                                if buttonPosition and not isPlayerCloseToButton(buttonPosition) then
                                    teleportToButton(buttonPosition)
                                    wait(1)
                                end
                                
                                -- Thử các phương thức click
                                pcall(function() fireclickdetector(detector) end)
                                wait(0.5)
                                pcall(function() fireclickdetector(detector) end)
                                
                                wait(3)
                                
                                -- Kiểm tra xem boss đã xuất hiện chưa và đánh
                                if bossExists() then
                                    fightBoss()
                                end
                            end
                        end
                    end
                end
                
                -- Nếu boss tồn tại và chưa đánh, bắt đầu đánh
                if bossExists() and not _G.IsFightingBoss then
                    fightBoss()
                end
                
                -- Kiểm tra nếu đã có tộc Cyborg
                if isCyborg() then
                    ForceStopChestCollection()
                    _G.AutoCyborg = false
                    _G.AutoJump = false
                    
                    game:GetService("StarterGui"):SetCore("SendNotification", {
                        Title = "Auto Cyborg",
                        Text = "Đã nhận thành công tộc Cyborg!",
                        Duration = 10
                    })
                    return
                end
                
                -- Kiểm tra xem người dùng có các công cụ mới không - đặc biệt là Fist of Darkness
                local player = game.Players.LocalPlayer
                if player and player.Backpack then
                    local checkBackpack = player.Backpack:GetChildren()
                    for _, item in pairs(checkBackpack) do
                        if item.Name == "Fist of Darkness" and not _G.FistDetected then
                            ForceStopChestCollection()
                            _G.FistDetected = true
                            _G.HasFistOfDarkness = true
                            _G.AutoJump = false
                            
                            -- Thông báo
                            game:GetService("StarterGui"):SetCore("SendNotification", {
                                Title = "Fist of Darkness",
                                Text = "Đã tìm thấy Fist of Darkness! Đang xử lý...",
                                Duration = 5
                            })
                            
                            -- Click detector nhiều lần
                            clickDetectorForNotification()
                            wait(1)
                            clickDetectorForNotification()
                            break
                        end
                    end
                end