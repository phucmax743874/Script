-- PHUCMAX Auto Bounty (single-file)
-- Merges features from original skidde modules into one self-contained Auto Bounty script
-- Mobile friendly, defensive (pcall), Teleport only used for low-HP escape and naive server rejoin (no HTTP)
-- Usage: paste/run in executor. Configure _G.PHUCMAX_Config before running if desired.

-------------------------------------------------------------------
-- CONFIG (edit before loading if you need different defaults)
-------------------------------------------------------------------
_G.PHUCMAX_Config = _G.PHUCMAX_Config or {}
local CFG = _G.PHUCMAX_Config

CFG.Team                = CFG.Team or "Pirate"        -- "Pirate" or "Marines"
CFG.MinLevel            = CFG.MinLevel or 612
CFG.SafeZoneEnabled     = (CFG.SafeZoneEnabled == nil) and true or CFG.SafeZoneEnabled
CFG.LowHPPercent        = CFG.LowHPPercent or 30      -- trigger escape at <= %
CFG.HealUntilPercent    = CFG.HealUntilPercent or 80  -- resume when >= %
CFG.FlySpeed            = CFG.FlySpeed or 350
CFG.SpamInterval        = CFG.SpamInterval or 0.12
CFG.AutoStart           = (CFG.AutoStart == nil) and true or CFG.AutoStart
CFG.UIBackgroundImage   = CFG.UIBackgroundImage or "rbxassetid://6023426913"
CFG.TargetMaxDistance   = CFG.TargetMaxDistance or 1200
CFG.ServerHopDebounce   = CFG.ServerHopDebounce or 12
CFG.Debug               = (CFG.Debug == nil) and true or CFG.Debug
CFG.ExcludeFriends      = (CFG.ExcludeFriends == nil) and true or CFG.ExcludeFriends
CFG.ExcludeCup         = (CFG.ExcludeCup == nil) and true or CFG.ExcludeCup

-------------------------------------------------------------------
-- HELPERS
-------------------------------------------------------------------
local function log(...)
    if CFG.Debug then
        local args = {...}
        for i=1,#args do args[i] = tostring(args[i]) end
        pcall(function() print("[PHUCMAX]", table.concat(args, " ")) end)
    end
end

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TeleportService = game:GetService("TeleportService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer

local function safeFindRemotes()
    local ok, rem = pcall(function() return ReplicatedStorage:FindFirstChild("Remotes") end)
    if ok and rem then return rem end
    return nil
end
local Remotes = safeFindRemotes()
local CommF_ = Remotes and Remotes:FindFirstChild("CommF_")
local CommE  = Remotes and Remotes:FindFirstChild("CommE")
local Validator2 = Remotes and Remotes:FindFirstChild("Validator2")

local function sInvoke(remote, ...)
    if not remote then return false, "no_remote" end
    local ok, res = pcall(function() return remote:InvokeServer(...) end)
    return ok, res
end
local function sFire(remote, ...)
    if not remote then return false end
    local ok = pcall(function() remote:FireServer(...) end)
    return ok
end

local function getChar(pl)
    if not pl then return nil end
    return pl.Character
end
local function getHum(pl)
    local c = getChar(pl)
    return c and c:FindFirstChildOfClass("Humanoid")
end
local function getHRP(pl)
    local c = getChar(pl)
    return c and c:FindFirstChild("HumanoidRootPart")
end
local function isAlive(pl)
    local h = getHum(pl)
    return h and h.Health > 0
end

local function getPlayerLevel(pl)
    if not pl then return nil end
    local ls = pl:FindFirstChild("leaderstats")
    if ls then
        local L = ls:FindFirstChild("Level") or ls:FindFirstChild("level") or ls:FindFirstChild("Lvl")
        if L and tonumber(L.Value) then return tonumber(L.Value) end
        local b = ls:FindFirstChild("Bounty/Honor") or ls:FindFirstChild("Bounty")
        if b and tonumber(b.Value) then return tonumber(b.Value) end
    end
    local d = pl:FindFirstChild("Data")
    if d then
        local L = d:FindFirstChild("Level") or d:FindFirstChild("level")
        if L and tonumber(L.Value) then return tonumber(L.Value) end
    end
    return nil
end

local function isFriend(pl)
    if not pl or not LocalPlayer then return false end
    local ok, res = pcall(function() return LocalPlayer:IsFriendsWith(pl.UserId) end)
    return ok and res
end

local function hasCup(pl)
    if not pl then return false end
    if pl:FindFirstChild("HasCup") then
        local v = pl:FindFirstChild("HasCup")
        return v.Value == true
    end
    if pl.Character and pl.Character:FindFirstChild("Cup") then return true end
    return false
end

local function inSafeZone(pl)
    if not pl or not pl.Character then return false end
    local char = pl.Character
    if char:FindFirstChild("InSafeZone") then
        local v = char:FindFirstChild("InSafeZone")
        if v and v.Value ~= nil then return v.Value end
    end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if hrp then
        for _, part in ipairs(Workspace:GetDescendants()) do
            if part:IsA("BasePart") and (part.Name:lower():find("safe") or part.Name:lower():find("zone")) then
                if (hrp.Position - part.Position).Magnitude <= (part.Size.Magnitude/2 + 6) then
                    return true
                end
            end
        end
    end
    return false
end

-------------------------------------------------------------------
-- TARGET SCAN
-------------------------------------------------------------------
local function isValidTarget(pl)
    if not pl or pl == LocalPlayer then return false end
    if not isAlive(pl) then return false end
    if CFG.ExcludeFriends and isFriend(pl) then return false end
    if CFG.ExcludeCup and hasCup(pl) then return false end
    if CFG.SafeZoneEnabled and inSafeZone(pl) then return false end
    local lvl = getPlayerLevel(pl)
    if lvl and lvl < CFG.MinLevel then return false end
    return true
end

local function scanNearest()
    local myHRP = getHRP(LocalPlayer)
    local best, bestd = nil, math.huge
    for _, p in ipairs(Players:GetPlayers()) do
        if isValidTarget(p) and p.Character and p.Character.Parent ~= nil then
            local hrp = getHRP(p)
            if hrp and myHRP then
                local d = (hrp.Position - myHRP.Position).Magnitude
                if d <= CFG.TargetMaxDistance and d < bestd then
                    bestd = d
                    best = p
                end
            elseif hrp then
                best = p; break
            end
        end
    end
    return best
end

-------------------------------------------------------------------
-- PREPARE ACTIONS (team, race, pvp, buso, ken, equip)
-------------------------------------------------------------------
local function autoSelectTeamOnce()
    if CommF_ then
        pcall(function() CommF_:InvokeServer("SetTeam", CFG.Team) end)
        log("Auto SelectTeam invoked:", CFG.Team)
    end
end

local lastPvP = 0
local function ensurePvP()
    if tick() - lastPvP < 2 then return end
    lastPvP = tick()
    pcall(function()
        local main = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("Main")
        if main and main:FindFirstChild("PvpDisabled") and main.PvpDisabled.Visible == true then
            if CommF_ then CommF_:InvokeServer("EnablePvp") end
        else
            if CommF_ then CommF_:InvokeServer("EnablePvp") end
        end
    end)
    log("Ensure PvP called")
end

local function ensureRaces()
    if CommF_ then
        pcall(function() CommF_:InvokeServer("RaceV3") end)
        pcall(function() CommF_:InvokeServer("RaceV4") end)
    end
    -- also attempt Mobile fallback for V4 not used (VM may not exist on mobile)
    log("RaceV3/V4 attempted")
end

local function ensureBuso()
    if CommF_ then pcall(function() CommF_:InvokeServer("Buso") end) end
end

local function ensureKen()
    if CommE then pcall(function() CommE:FireServer("Ken", true) end) end
    pcall(function()
        local gui = LocalPlayer:FindFirstChild("PlayerGui")
        if gui and gui.MobileContextButtons then
            local frame = gui.MobileContextButtons:FindFirstChild("ContextButtonFrame")
            if frame then
                local btn = frame:FindFirstChild("BoundActionKen")
                if btn and btn:GetAttribute("Selected") ~= true then btn:SetAttribute("Selected", true) end
            end
        end
    end)
end

local function equipDefaultMelee()
    local char = LocalPlayer.Character
    local backpack = LocalPlayer:FindFirstChild("Backpack")
    local list = {}
    if char then for _, v in ipairs(char:GetChildren()) do if v:IsA("Tool") then table.insert(list, v) end end end
    if backpack then for _, v in ipairs(backpack:GetChildren()) do if v:IsA("Tool") then table.insert(list, v) end end end
    for _,t in ipairs(list) do
        local tip = tostring(t.ToolTip or ""):lower()
        local name = tostring(t.Name or ""):lower()
        if tip:find("melee") or tip:find("fist") or tip:find("blade") or name:find("melee") or name:find("sword") then
            pcall(function()
                if t.Parent ~= char then t.Parent = char end
                local hum = char:FindFirstChildOfClass("Humanoid")
                if hum then hum:EquipTool(t) end
            end)
            log("Equipped melee tool:", t.Name)
            return t
        end
    end
    if list[1] then
        pcall(function()
            if list[1].Parent ~= char then list[1].Parent = char end
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum then hum:EquipTool(list[1]) end
        end)
        log("Equipped fallback tool:", list[1].Name)
        return list[1]
    end
    log("No tool to equip")
    return nil
end

-------------------------------------------------------------------
-- MOVEMENT: NoClip + fly (non-teleport)
-------------------------------------------------------------------
local noclipConn = nil
local function setNoClip(enable)
    if noclipConn then noclipConn:Disconnect(); noclipConn = nil end
    if enable then
        noclipConn = RunService.Heartbeat:Connect(function()
            local char = LocalPlayer.Character
            if not char then return end
            for _, part in ipairs(char:GetDescendants()) do
                if part:IsA("BasePart") then pcall(function() part.CanCollide = false end) end
            end
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum then pcall(function() hum.PlatformStand = true end) end
        end)
    else
        local char = LocalPlayer.Character
        if char then
            for _, part in ipairs(char:GetDescendants()) do
                if part:IsA("BasePart") then pcall(function() part.CanCollide = true end) end
            end
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum then pcall(function() hum.PlatformStand = false end) end
        end
    end
end

local function flyTo(pos, speed)
    if not pos then return end
    local char = LocalPlayer.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    speed = speed or CFG.FlySpeed
    local goal = CFrame.new(pos) * CFrame.new(0, 3, 0)
    local t = math.clamp((speed/1500), 0.02, 0.65)
    pcall(function() hrp.CFrame = hrp.CFrame:Lerp(goal, t) end)
    pcall(function() hrp.CFrame = CFrame.new(hrp.Position, pos) end)
end

-------------------------------------------------------------------
-- COMBAT: spam skills & cycle tools
-------------------------------------------------------------------
local lastSpamTime = 0
local function spamSkillsOn(target)
    if not target or not target.Character then return end
    if tick() - lastSpamTime < CFG.SpamInterval then return end
    lastSpamTime = tick()
    local pos
    pcall(function() local hrp = target.Character:FindFirstChild("HumanoidRootPart"); if hrp then pos = hrp.Position end end)
    -- call commonly used remote payloads (best-effort)
    if CommE then
        pcall(function()
            CommE:FireServer("Z", pos)
            CommE:FireServer("X", pos)
            CommE:FireServer("C", pos)
            CommE:FireServer("V", pos)
        end)
    end
    if CommF_ then
        pcall(function()
            CommF_:InvokeServer("UseSkill", "Z", pos)
            CommF_:InvokeServer("UseSkill", "X", pos)
            CommF_:InvokeServer("UseSkill", "C", pos)
            CommF_:InvokeServer("UseSkill", "V", pos)
            CommF_:InvokeServer("Attack", pos)
        end)
    end
end

local function cycleTools()
    local char = LocalPlayer.Character
    if not char then return nil end
    local backpack = LocalPlayer:FindFirstChild("Backpack")
    local candidates = {}
    if char then for _, t in ipairs(char:GetChildren()) do if t:IsA("Tool") then table.insert(candidates,t) end end end
    if backpack then for _, t in ipairs(backpack:GetChildren()) do if t:IsA("Tool") then table.insert(candidates,t) end end end
    local order = {"melee","sword","fruit","gun"}
    for _, kw in ipairs(order) do
        for _, tool in ipairs(candidates) do
            local tip = tostring(tool.ToolTip or ""):lower()
            local name = tostring(tool.Name or ""):lower()
            if tip:find(kw) or name:find(kw) then
                pcall(function()
                    if tool.Parent ~= char then tool.Parent = char end
                    local hum = char:FindFirstChildOfClass("Humanoid")
                    if hum then hum:EquipTool(tool) end
                end)
                return tool
            end
        end
    end
    if candidates[1] then
        pcall(function()
            if candidates[1].Parent ~= char then candidates[1].Parent = char end
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum then hum:EquipTool(candidates[1]) end
        end)
        return candidates[1]
    end
    return nil
end

-------------------------------------------------------------------
-- LOW HP ESCAPE (only place teleport allowed)
-------------------------------------------------------------------
local function lowHpEscape(oldTarget)
    log("Low HP: teleporting up")
    pcall(function()
        local char = LocalPlayer.Character
        if not char then return end
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if hrp then hrp.CFrame = hrp.CFrame + Vector3.new(0, 1000, 0) end
    end)
    setNoClip(true)
    -- ascend until healed
    while true do
        if not LocalPlayer then break end
        local hum = getHum(LocalPlayer)
        if hum then
            local perc = (hum.Health / (hum.MaxHealth > 0 and hum.MaxHealth or 1)) * 100
            if perc >= CFG.HealUntilPercent then break end
        end
        pcall(function()
            local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if hrp then hrp.CFrame = hrp.CFrame + Vector3.new(0, 50, 0) end
        end)
        task.wait(0.6)
    end
    -- teleport down to old target if possible
    if oldTarget and oldTarget.Character and oldTarget.Character:FindFirstChild("HumanoidRootPart") then
        local pos = oldTarget.Character.HumanoidRootPart.Position
        pcall(function()
            local char = LocalPlayer.Character
            if char and char:FindFirstChild("HumanoidRootPart") then
                char.HumanoidRootPart.CFrame = CFrame.new(pos + Vector3.new(0,5,0))
            end
        end)
    end
    setNoClip(true)
    log("Escape complete, reengaging")
end

-------------------------------------------------------------------
-- SERVER HOP (naive TeleportService hop)
-------------------------------------------------------------------
local lastHop = 0
local function canHop()
    local ok, pvpDisabled = pcall(function()
        local main = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("Main")
        if main and main:FindFirstChild("PvpDisabled") then return main.PvpDisabled.Visible end
        return true
    end)
    if ok then return pvpDisabled else return true end
end

local function serverHop()
    if tick() - lastHop < CFG.ServerHopDebounce then return end
    if not canHop() then log("In PvP, delaying hop") return end
    lastHop = tick()
    pcall(function() TeleportService:Teleport(game.PlaceId, LocalPlayer) end)
    log("Server hop attempted")
end

-------------------------------------------------------------------
-- STATE MACHINE / MAIN LOOP
-------------------------------------------------------------------
local running = false
local currentTarget = nil

local function prepareAll()
    autoSelectTeamOnce()
    ensureRaces()
    ensurePvP()
    ensureBuso()
    ensureKen()
    equipDefaultMelee()
end

local function mainLoop()
    log("AutoBounty main loop started")
    while running do
        -- ensure basic preparations often
        prepareAll()

        -- acquire target if none or invalid
        if not currentTarget or not isValidTarget(currentTarget) then
            currentTarget = scanNearest()
            if currentTarget then log("Target found:", currentTarget.Name) end
        end

        if currentTarget and isValidTarget(currentTarget) then
            -- ENGAGE
            setNoClip(true)
            local trgHRP = getHRP(currentTarget)
            if trgHRP then flyTo(trgHRP.Position, CFG.FlySpeed) end

            -- keep facing and spam
            spamSkillsOn(currentTarget)
            cycleTools()

            -- HP check
            local myHum = getHum(LocalPlayer)
            if myHum then
                local perc = (myHum.Health / (myHum.MaxHealth > 0 and myHum.MaxHealth or 1)) * 100
                if perc <= CFG.LowHPPercent then
                    lowHpEscape(currentTarget)
                end
            end

            -- if target died, reset
            if not isAlive(currentTarget) then
                log("Target died:", currentTarget and currentTarget.Name or "nil")
                currentTarget = nil
                setNoClip(false)
                task.wait(0.6)
            end
        else
            -- NO TARGET: server hop if safe
            log("No target: will check server hop")
            if canHop() then
                serverHop()
                task.wait(4)
            else
                task.wait(3)
            end
        end
        task.wait(0.12)
    end
    log("AutoBounty main loop stopped")
    setNoClip(false)
end

-------------------------------------------------------------------
-- RESPAWN HANDLER
-------------------------------------------------------------------
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    if running then
        log("Respawn detected: re-preparing and continuing")
        prepareAll()
        setNoClip(false)
        task.wait(1)
    end
end)

-------------------------------------------------------------------
-- UI (draggable rectangle + small toggle square)
-------------------------------------------------------------------
local function createUI()
    local ok, screen = pcall(function()
        local sg = Instance.new("ScreenGui")
        sg.Name = "PHUCMAX_AutoBounty_UI"
        sg.ResetOnSpawn = false
        sg.Parent = LocalPlayer:WaitForChild("PlayerGui")
        return sg
    end)
    if not ok then return end

    local sg = screen

    local panel = Instance.new("Frame")
    panel.Name = "Panel"
    panel.Size = UDim2.new(0, 360, 0, 150)
    panel.Position = UDim2.new(0.5, -180, 0.06, 0)
    panel.AnchorPoint = Vector2.new(0.5, 0)
    panel.BackgroundColor3 = Color3.fromRGB(22,22,28)
    panel.BorderSizePixel = 0
    panel.Parent = sg
    local pc = Instance.new("UICorner", panel); pc.CornerRadius = UDim.new(0,8)

    local bg = Instance.new("ImageLabel", panel)
    bg.Size = UDim2.new(1,0,1,0); bg.BackgroundTransparency = 1
    bg.Image = CFG.UIBackgroundImage; bg.ImageTransparency = 0.45; bg.ScaleType = Enum.ScaleType.Crop

    local title = Instance.new("TextLabel", panel)
    title.Text = "PHUCMAX bounty"; title.Font = Enum.Font.GothamBold; title.TextSize = 18
    title.TextColor3 = Color3.fromRGB(255,255,255); title.BackgroundTransparency = 1
    title.Position = UDim2.new(0.02,0,0.03,0); title.Size = UDim2.new(0.6,0,0.16,0); title.TextXAlignment = Enum.TextXAlignment.Left

    local by = Instance.new("TextLabel", panel)
    by.Text = "by PHUCMAX"; by.Font = Enum.Font.Gotham; by.TextSize = 12
    by.TextColor3 = Color3.fromRGB(200,200,200); by.BackgroundTransparency = 1
    by.Position = UDim2.new(0.02,0,0.19,0); by.Size = UDim2.new(0.6,0,0.12,0)

    local timeLabel = Instance.new("TextLabel", panel)
    timeLabel.Text = os.date("%H:%M:%S"); timeLabel.Font = Enum.Font.Gotham; timeLabel.TextSize = 12
    timeLabel.TextColor3 = Color3.fromRGB(200,200,200); timeLabel.BackgroundTransparency = 1
    timeLabel.Position = UDim2.new(0.02,0,0.34,0); timeLabel.Size = UDim2.new(0.6,0,0.12,0)

    local bountyLabel = Instance.new("TextLabel", panel)
    bountyLabel.Text = "Bounty: --"; bountyLabel.Font = Enum.Font.Gotham; bountyLabel.TextSize = 14
    bountyLabel.TextColor3 = Color3.fromRGB(255,200,50); bountyLabel.BackgroundTransparency = 1
    bountyLabel.Position = UDim2.new(0.02,0,0.50,0); bountyLabel.Size = UDim2.new(0.6,0,0.14,0)

    local function makeBtn(text, x)
        local b = Instance.new("TextButton", panel)
        b.Size = UDim2.new(0.3, 0, 0.18, 0); b.Position = UDim2.new(x,0,0.72,0)
        b.BackgroundColor3 = Color3.fromRGB(40,40,55); b.Text = text; b.Font = Enum.Font.GothamSemibold
        b.TextSize = 13; b.TextColor3 = Color3.fromRGB(230,230,230)
        local c = Instance.new("UICorner", b); c.CornerRadius = UDim.new(0,6)
        return b
    end

    local btnNext = makeBtn("Next Player", 0.02)
    local btnHop  = makeBtn("Hop Server", 0.36)
    local btnReset = makeBtn("Reset", 0.70)

    btnNext.MouseButton1Click:Connect(function()
        currentTarget = nil
        log("Next Player pressed")
    end)
    btnHop.MouseButton1Click:Connect(function()
        serverHop()
    end)
    btnReset.MouseButton1Click:Connect(function()
        currentTarget = nil
        setNoClip(false)
        prepareAll()
        log("Reset pressed")
    end)

    -- small toggle square top-left
    local toggle = Instance.new("Frame", sg)
    toggle.Size = UDim2.new(0, 40, 0, 40); toggle.Position = UDim2.new(0,8,0,8)
    toggle.BackgroundColor3 = Color3.fromRGB(35,35,50)
    local tc = Instance.new("UICorner", toggle); tc.CornerRadius = UDim.new(0,6)
    local tlabel = Instance.new("TextLabel", toggle)
    tlabel.Size = UDim2.new(1,0,1,0); tlabel.BackgroundTransparency = 1; tlabel.Text = "UI"; tlabel.Font = Enum.Font.GothamSemibold
    tlabel.TextColor3 = Color3.fromRGB(230,230,230); tlabel.TextSize = 14

    toggle.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.Touch or inp.UserInputType == Enum.UserInputType.MouseButton1 then
            panel.Visible = not panel.Visible
        end
    end)

    -- draggable helpers (supports touch & mouse)
    local function makeDraggable(obj)
        local dragging, dragInput, dragStart, startPos = false, nil, nil, nil
        obj.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = true; dragStart = input.Position; startPos = obj.Position
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then dragging = false end
                end)
            end
        end)
        obj.InputChanged:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
                dragInput = input
            end
        end)
        UserInputService.InputChanged:Connect(function(input)
            if input == dragInput and dragging and dragStart and startPos then
                local delta = input.Position - dragStart
                obj.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            end
        end)
    end

    makeDraggable(panel); makeDraggable(toggle)

    -- update time & bounty
    spawn(function()
        while panel.Parent do
            pcall(function()
                timeLabel.Text = os.date("%H:%M:%S")
                local val = "--"
                pcall(function()
                    local ls = LocalPlayer:FindFirstChild("leaderstats")
                    if ls then local b = ls:FindFirstChild("Bounty/Honor") or ls:FindFirstChild("Bounty") if b then val = tostring(b.Value) end end
                end)
                bountyLabel.Text = "Bounty: " .. val
            end)
            task.wait(1)
        end
    end)
end

-------------------------------------------------------------------
-- START / STOP
-------------------------------------------------------------------
local automationThread = nil
function startAutoBounty()
    if running then log("Already running") return end
    running = true
    automationThread = task.spawn(mainLoop)
    log("AutoBounty started")
end

function stopAutoBounty()
    if not running then log("Not running") return end
    running = false
    if automationThread then pcall(function() task.cancel(automationThread) end) automationThread = nil end
    setNoClip(false)
    log("AutoBounty stopped")
end

_G.PHUCMAX_AutoBounty = _G.PHUCMAX_AutoBounty or {}
_G.PHUCMAX_AutoBounty.Start = startAutoBounty
_G.PHUCMAX_AutoBounty.Stop = stopAutoBounty
_G.PHUCMAX_AutoBounty.IsRunning = function() return running end
_G.PHUCMAX_AutoBounty.Config = CFG

-- create UI safely
pcall(createUI)

-- wait for game ready (DataLoaded) and run initial prepare then auto-start if requested
task.spawn(function()
    log("Waiting for game load and DataLoaded")
    repeat task.wait() until game:IsLoaded()
    repeat task.wait() until LocalPlayer:FindFirstChild("DataLoaded")
    -- refresh remotes reference (in case they appeared later)
    Remotes = safeFindRemotes() or Remotes
    CommF_ = Remotes and Remotes:FindFirstChild("CommF_") or CommF_
    CommE  = Remotes and Remotes:FindFirstChild("CommE") or CommE
    log("Remotes found:", (Remotes ~= nil), "CommF_:", (CommF_ ~= nil), "CommE:", (CommE ~= nil))
    prepareAll()
    if CFG.AutoStart then
        startAutoBounty()
    else
        log("AutoStart disabled; call _G.PHUCMAX_AutoBounty.Start() to begin")
    end
end)

log("PHUCMAX Auto Bounty loaded (mobile friendly).")