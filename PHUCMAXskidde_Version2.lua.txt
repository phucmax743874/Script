-- PHUCMAX Auto Bounty (merged + updated)
-- Implements: Auto select team on join, Auto Race V3/V4, Auto PvP enable, Auto Haki (Buso/Ken),
-- Fly-to-target (speed 350), NoClip + anti-fall while flying, stick & spam skills, tool cycle,
-- Low-HP teleport-up escape, re-engage, respawn handling, naive server-hop, draggable UI with controls.
-- Author: PHUCMAX (adapted)

-- CONFIG (users may edit global config before load)
_G["HoHo Hub Auto Bounty V36"] = _G["HoHo Hub Auto Bounty V36"] or {}
local cfg = _G["HoHo Hub Auto Bounty V36"]
cfg["Select Team"] = cfg["Select Team"] or "Pirate"       -- "Pirate" or "Marines"
cfg["Max Level Distance"] = cfg["Max Level Distance"] or 612
cfg["Don't attack friends"] = (cfg["Don't attack friends"] == nil) and true or cfg["Don't attack friends"]
cfg["Don't attack player have cup"] = (cfg["Don't attack player have cup"] == nil) and true or cfg["Don't attack player have cup"]
cfg.SafeZone = cfg.SafeZone or { Enabled = true, ["Health Left (%)"] = 30, ["Wait Until Heal (%)"] = 80 }
cfg["AutoStart"] = (cfg.AutoStart == nil) and true or cfg.AutoStart
cfg.UIBackgroundImage = cfg["UIBackgroundImage"] or "rbxassetid://6023426913" -- default background

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TeleportService = game:GetService("TeleportService")
local VirtualInputManager = pcall(function() return game:GetService("VirtualInputManager") end) and game:GetService("VirtualInputManager") or nil
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer

-- Remotes (best-effort)
local Remotes = ReplicatedStorage:FindFirstChild("Remotes")
local CommF_ = Remotes and Remotes:FindFirstChild("CommF_")
local CommE  = Remotes and Remotes:FindFirstChild("CommE")
local Validator2 = Remotes and Remotes:FindFirstChild("Validator2")

-- Internal state
local running = false
local currentTarget = nil
local lastTargetSkipTick = 0
local lastTeamSelectTick = 0
local lastPvPEnableTick = 0
local lastServerHopTick = 0
local targetAcquireTick = 0

-- Utility safe wrappers
local function sInvoke(r, ...)
    if not r then return false end
    local ok, res = pcall(function() return r:InvokeServer(...) end)
    return ok, res
end
local function sFire(r, ...)
    if not r then return false end
    local ok = pcall(function() r:FireServer(...) end)
    return ok
end

-- Short helpers
local function getHRP(pl)
    if not pl or not pl.Character then return nil end
    return pl.Character:FindFirstChild("HumanoidRootPart")
end
local function getHum(pl)
    if not pl or not pl.Character then return nil end
    return pl.Character:FindFirstChildOfClass("Humanoid")
end
local function isAlive(pl) local h = getHum(pl) return h and h.Health > 0 end

-- Friend / Cup / Safe zone checks (heuristic)
local function isFriend(pl)
    if not pl then return false end
    local ok, res = pcall(function() return LocalPlayer:IsFriendsWith(pl.UserId) end)
    return ok and res
end

local function hasCup(pl)
    if not pl then return false end
    if pl:FindFirstChild("HasCup") then
        local v = pl:FindFirstChild("HasCup")
        return v.Value == true
    end
    if pl.Character and pl.Character:FindFirstChild("Cup") then return true end
    return false
end

local function inSafeZone(pl)
    if not pl or not pl.Character then return false end
    if pl.Character:FindFirstChild("InSafeZone") then
        local v = pl.Character:FindFirstChild("InSafeZone")
        if v.Value ~= nil then return v.Value end
    end
    -- fallback: check proximity to parts whose name contains "safe"
    local hrp = getHRP(pl)
    if hrp then
        for _, part in ipairs(workspace:GetDescendants()) do
            if part:IsA("BasePart") and (part.Name:lower():find("safe") or part.Name:lower():find("zone")) then
                if (hrp.Position - part.Position).Magnitude <= (part.Size.Magnitude/2 + 6) then return true end
            end
        end
    end
    return false
end

-- Level detection heuristic
local function getPlayerLevel(pl)
    if not pl then return nil end
    local ls = pl:FindFirstChild("leaderstats")
    if ls then
        local L = ls:FindFirstChild("Level") or ls:FindFirstChild("level") or ls:FindFirstChild("Lvl")
        if L and tonumber(L.Value) then return tonumber(L.Value) end
        local bounty = ls:FindFirstChild("Bounty/Honor") or ls:FindFirstChild("Bounty")
        if bounty and tonumber(bounty.Value) then return tonumber(bounty.Value) end
    end
    local d = pl:FindFirstChild("Data")
    if d then
        local L = d:FindFirstChild("Level") or d:FindFirstChild("level")
        if L and tonumber(L.Value) then return tonumber(L.Value) end
    end
    return nil
end

-- Target validity
local function isValidTarget(pl)
    if not pl or pl == LocalPlayer then return false end
    if not isAlive(pl) then return false end
    if cfg["Don't attack friends"] and isFriend(pl) then return false end
    if cfg["Don't attack player have cup"] and hasCup(pl) then return false end
    if cfg.SafeZone and cfg.SafeZone.Enabled and inSafeZone(pl) then return false end
    local lvl = getPlayerLevel(pl)
    if lvl and tonumber(lvl) < tonumber(cfg["Max Level Distance"]) then return false end
    return true
end

-- Scan nearest valid target
local function scanForTarget()
    local best, bestd = nil, math.huge
    local myHRP = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    for _, pl in ipairs(Players:GetPlayers()) do
        if isValidTarget(pl) then
            local hrp = pl.Character and pl.Character:FindFirstChild("HumanoidRootPart")
            if hrp and myHRP then
                local d = (hrp.Position - myHRP.Position).Magnitude
                if d < bestd then bestd = d best = pl end
            elseif hrp then
                best = pl; break
            end
        end
    end
    return best
end

-- Team select (run once per join)
local function selectTeam()
    if tick() - lastTeamSelectTick < 5 then return end
    lastTeamSelectTick = tick()
    if CommF_ then
        pcall(function() CommF_:InvokeServer("SetTeam", cfg["Select Team"]) end)
    end
end

-- Ensure PvP enabled
local function ensurePvP()
    if tick() - lastPvPEnableTick < 2 then return end
    lastPvPEnableTick = tick()
    local ok = pcall(function()
        local gui = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("Main")
        if gui and gui:FindFirstChild("PvpDisabled") and gui.PvpDisabled.Visible == true then
            if CommF_ then CommF_:InvokeServer("EnablePvp") end
        else
            -- if GUI not present, still call invoke to enable
            if CommF_ then CommF_:InvokeServer("EnablePvp") end
        end
    end)
    return ok
end

-- Enable race V3/V4 best-effort
local function enableRaces()
    if CommF_ then
        pcall(function() CommF_:InvokeServer("RaceV3") end)
        pcall(function() CommF_:InvokeServer("RaceV4") end)
    end
    if VirtualInputManager then
        pcall(function() VirtualInputManager:SendKeyEvent(true, "Y", false, game) end)
        pcall(function() VirtualInputManager:SendKeyEvent(false, "Y", false, game) end)
    end
end

-- Enable Buso
local function ensureBuso()
    if CommF_ then
        pcall(function() CommF_:InvokeServer("Buso") end)
    end
end

-- Enable Ken (observation)
local function ensureKen()
    if CommE then
        pcall(function() CommE:FireServer("Ken", true) end)
    end
    -- also try to set mobile button if present
    pcall(function()
        local gui = LocalPlayer:FindFirstChild("PlayerGui")
        if gui and gui:FindFirstChild("MobileContextButtons") then
            local kb = gui.MobileContextButtons:FindFirstChild("ContextButtonFrame") and gui.MobileContextButtons.ContextButtonFrame:FindFirstChild("BoundActionKen")
            if kb and kb:GetAttribute("Selected") ~= true then kb:SetAttribute("Selected", true) end
        end
    end)
end

-- Equip first melee-like tool
local function equipDefaultMelee()
    local backpack = LocalPlayer:FindFirstChild("Backpack")
    local char = LocalPlayer.Character
    local function tryEquip(tool)
        if not tool then return false end
        local ok, res = pcall(function()
            if tool.Parent ~= char then
                tool.Parent = char
            end
            if char and char:FindFirstChildOfClass("Humanoid") then
                char:FindFirstChildOfClass("Humanoid"):EquipTool(tool)
            end
        end)
        return ok
    end
    -- prefer tools with ToolTip containing "Melee" or "Sword" or "Melee"
    local order = {}
    if backpack then
        for _, t in ipairs(backpack:GetChildren()) do table.insert(order,t) end
    end
    if char then
        for _, t in ipairs(char:GetChildren()) do if t:IsA("Tool") then table.insert(order,t) end end
    end
    for _, tool in ipairs(order) do
        local tip = tostring(tool.ToolTip or ""):lower()
        if tip:find("melee") or tip:find("sword") or tip:find("blade") or tip:find("fist") then
            if tryEquip(tool) then return true end
        end
    end
    -- fallback: equip first tool
    for _, tool in ipairs(order) do
        if tryEquip(tool) then return true end
    end
    return false
end

-- NoClip & anti-fall
local noclipEnabled = false
local function setNoClip(enable)
    local char = LocalPlayer.Character
    if not char then return end
    noclipEnabled = enable
    pcall(function()
        for _, part in ipairs(char:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = not enable and true or false
            end
        end
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then
            hum.PlatformStand = enable -- platformstand prevents ragdoll physics while we set CFrames
        end
    end)
end

-- Fly toward function (non-teleport)
local function flyTowardPosition(position, speed)
    if not position then return end
    local char = LocalPlayer.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    speed = speed or 350
    -- lerp the hrp towards target
    local current = hrp.CFrame
    local goal = CFrame.new(position) * CFrame.new(0, 3, 0)
    -- compute factor based on speed and dt
    local dt = math.clamp(task.wait(0) or 1/60, 0.01, 0.033)
    local t = math.clamp((speed / 1500), 0.01, 0.6)
    hrp.CFrame = hrp.CFrame:Lerp(goal, t)
    -- ensure facing
    pcall(function() hrp.CFrame = CFrame.new(hrp.Position, position) end)
end

-- Teleport only for low-HP escape and reengage
local function teleportUp(height)
    height = height or 1000
    local char = LocalPlayer.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    pcall(function() hrp.CFrame = hrp.CFrame + Vector3.new(0, height, 0) end)
end
local function teleportTo(pos)
    if not pos then return end
    local char = LocalPlayer.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    pcall(function() hrp.CFrame = CFrame.new(pos + Vector3.new(0,5,0)) end)
end

-- Server hop (naive best-effort)
local function serverHop()
    if tick() - lastServerHopTick < 10 then return end
    lastServerHopTick = tick()
    -- NOTE: to implement reliable server hop, call Roblox API to retrieve servers and TeleportToPlaceInstance.
    -- We'll do a naive teleport (likely rejoin same server) to avoid HTTP usage in this script.
    pcall(function() TeleportService:Teleport(game.PlaceId, LocalPlayer) end)
end

-- Spam skills on target (best-effort patterns)
local lastSpam = 0
local SPAM_INTERVAL = 0.12
local function spamSkillsOnTarget(target)
    if not target or not target.Character then return end
    if tick() - lastSpam < SPAM_INTERVAL then return end
    lastSpam = tick()
    local hrp = target.Character:FindFirstChild("HumanoidRootPart")
    local pos = hrp and hrp.Position
    -- Try common remote patterns (pcall to avoid errors)
    if CommE then
        pcall(function()
            -- many Blox-Fruit servers accept "Z"/"X"/"C"/"V" via CommE FireServer
            CommE:FireServer("Z", pos)
            CommE:FireServer("X", pos)
            CommE:FireServer("C", pos)
            CommE:FireServer("V", pos)
        end)
    end
    if CommF_ then
        pcall(function()
            CommF_:InvokeServer("UseSkill", "Z", pos)
            CommF_:InvokeServer("UseSkill", "X", pos)
            CommF_:InvokeServer("UseSkill", "C", pos)
            CommF_:InvokeServer("UseSkill", "V", pos)
        end)
    end
    -- generic Attack remote fallback
    if CommF_ then pcall(function() CommF_:InvokeServer("Attack", pos) end) end
end

-- Cycle tool order: Melee -> Sword -> Fruit -> Gun
local function cycleTools()
    local char = LocalPlayer.Character
    local backpack = LocalPlayer:FindFirstChild("Backpack")
    local candidates = {}
    if char then
        for _, t in ipairs(char:GetChildren()) do if t:IsA("Tool") then table.insert(candidates, t) end end
    end
    if backpack then
        for _, t in ipairs(backpack:GetChildren()) do if t:IsA("Tool") then table.insert(candidates, t) end end
    end
    local orderKeywords = { "melee", "sword", "fruit", "gun" }
    for _, kw in ipairs(orderKeywords) do
        for _, tool in ipairs(candidates) do
            local tip = tostring(tool.ToolTip or ""):lower()
            local name = tostring(tool.Name or ""):lower()
            if tip:find(kw) or name:find(kw) then
                pcall(function()
                    if tool.Parent ~= char then tool.Parent = char end
                    local hum = char:FindFirstChildOfClass("Humanoid")
                    if hum then hum:EquipTool(tool) end
                end)
                return tool
            end
        end
    end
    -- fallback: equip first
    if candidates[1] then
        pcall(function()
            if candidates[1].Parent ~= char then candidates[1].Parent = char end
            local hum = char:FindFirstChildOfClass("Humanoid")
            if hum then hum:EquipTool(candidates[1]) end
        end)
        return candidates[1]
    end
    return nil
end

-- Low HP escape: teleport up 1000, ascend until healed to waitpercent, then teleport back to target pos
local function lowHpEscapeLoop(oldTarget)
    -- teleport up once
    teleportUp(1000)
    setNoClip(true)
    -- ascend until healed
    while running do
        local hum = getHum(LocalPlayer)
        if hum then
            local perc = (hum.Health / (hum.MaxHealth > 0 and hum.MaxHealth or 1)) * 100
            if perc >= (cfg.SafeZone["Wait Until Heal (%)"] or 80) then
                break
            end
        end
        -- keep small upward increments
        pcall(function()
            local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if hrp then hrp.CFrame = hrp.CFrame + Vector3.new(0, 50, 0) end
        end)
        task.wait(0.6)
    end
    -- teleport down to last known target pos
    if oldTarget and oldTarget.Character and oldTarget.Character:FindFirstChild("HumanoidRootPart") then
        teleportTo(oldTarget.Character.HumanoidRootPart.Position)
    end
    setNoClip(true)
end

-- Main loop state machine (simplified per spec)
local function mainLoop()
    while running do
        -- ensure basic buffs and team selection after join
        selectTeam()
        enableRaces()
        ensurePvP()
        ensureBuso()
        ensureKen()
        equipDefaultMelee()

        -- select or keep target
        if not currentTarget or not isValidTarget(currentTarget) then
            currentTarget = scanForTarget()
            if currentTarget then targetAcquireTick = tick() end
        end

        -- If a target exists: engage & combat
        if currentTarget and isValidTarget(currentTarget) then
            -- engage: fly to target, noclip, anti-fall
            setNoClip(true)
            local trgHRP = getHRP(currentTarget)
            if trgHRP then
                flyTowardPosition(trgHRP.Position, 350)
                -- always aim camera toward target
                pcall(function()
                    local cam = workspace.CurrentCamera
                    cam.CFrame = CFrame.new(cam.CFrame.Position, trgHRP.Position)
                end)
            end

            -- combat: spam skills + switch tools
            spamSkillsOnTarget(currentTarget)
            cycleTools() -- ensure cycling tools while in combat

            -- monitor hp both sides
            local myHum = getHum(LocalPlayer)
            local trgHum = getHum(currentTarget)
            if myHum and (myHum.Health / (myHum.MaxHealth > 0 and myHum.MaxHealth or 1)) * 100 <= (cfg.SafeZone["Health Left (%)"] or 30) then
                -- low HP escape: only place teleport allowed
                lowHpEscapeLoop(currentTarget)
            end

            if not isAlive(currentTarget) then
                currentTarget = nil
                task.wait(0.6)
            end
        else
            -- no target found
            -- Check PvP status: if not in PvP then server hop; if in PvP wait until PvP disabled then hop
            local pvpDisabled = true
            pcall(function()
                local gui = LocalPlayer.PlayerGui and LocalPlayer.PlayerGui:FindFirstChild("Main")
                if gui and gui:FindFirstChild("PvpDisabled") then pvpDisabled = gui.PvpDisabled.Visible end
            end)
            if pvpDisabled then
                serverHop()
                -- after hop reset state and wait for respawn
                task.wait(3)
            else
                -- wait for PvP to end or for possible new players
                task.wait(3)
            end
        end

        task.wait(0.12)
    end
    -- cleanup when stop
    setNoClip(false)
end

-- Respawn handler: re-enable all states and resume
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    if running then
        enableRaces()
        ensurePvP()
        ensureBuso()
        ensureKen()
        setNoClip(false)
        -- attempt to resume target seek quickly
        task.wait(1)
    end
end)

-- UI: draggable rectangle with background, small toggle square top-left draggable, inside shows title/by/time/bounty + 3 buttons
local gui = Instance.new("ScreenGui")
gui.Name = "PHUCMAX_Bounty_UI"
gui.ResetOnSpawn = false
gui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- main panel
local frame = Instance.new("Frame")
frame.Name = "MainPanel"
frame.Size = UDim2.new(0, 360, 0, 160)
frame.Position = UDim2.new(0.5, -180, 0.1, 0)
frame.AnchorPoint = Vector2.new(0.5, 0)
frame.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
frame.BorderSizePixel = 0
frame.Parent = gui

-- background image
local bg = Instance.new("ImageLabel")
bg.Name = "BG"
bg.Size = UDim2.new(1, 0, 1, 0)
bg.Position = UDim2.new(0, 0, 0, 0)
bg.Image = cfg.UIBackgroundImage
bg.BackgroundTransparency = 1
bg.ImageColor3 = Color3.fromRGB(255,255,255)
bg.ScaleType = Enum.ScaleType.Crop
bg.Parent = frame

-- border
local border = Instance.new("UICorner")
border.CornerRadius = UDim.new(0, 8)
border.Parent = frame

local outline = Instance.new("Frame")
outline.Name = "Outline"
outline.Size = UDim2.new(1, 4, 1, 4)
outline.Position = UDim2.new(0, -2, 0, -2)
outline.BackgroundTransparency = 1
outline.BorderSizePixel = 0
outline.Parent = frame

-- Title
local title = Instance.new("TextLabel")
title.Name = "Title"
title.Text = "PHUCMAX bounty"
title.Font = Enum.Font.GothamBold
title.TextSize = 18
title.TextColor3 = Color3.fromRGB(255,255,255)
title.BackgroundTransparency = 1
title.Position = UDim2.new(0.02, 0, 0.04, 0)
title.Size = UDim2.new(0.6, 0, 0.18, 0)
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = frame

local byline = Instance.new("TextLabel")
byline.Name = "By"
byline.Text = "by PHUCMAX"
byline.Font = Enum.Font.Gotham
byline.TextSize = 12
byline.TextColor3 = Color3.fromRGB(200,200,200)
byline.BackgroundTransparency = 1
byline.Position = UDim2.new(0.02, 0, 0.18, 0)
byline.Size = UDim2.new(0.6, 0, 0.14, 0)
byline.TextXAlignment = Enum.TextXAlignment.Left
byline.Parent = frame

local timeLabel = Instance.new("TextLabel")
timeLabel.Name = "Time"
timeLabel.Text = os.date("%H:%M:%S")
timeLabel.Font = Enum.Font.Gotham
timeLabel.TextSize = 12
timeLabel.TextColor3 = Color3.fromRGB(200,200,200)
timeLabel.BackgroundTransparency = 1
timeLabel.Position = UDim2.new(0.02, 0, 0.34, 0)
timeLabel.Size = UDim2.new(0.6, 0, 0.14, 0)
timeLabel.TextXAlignment = Enum.TextXAlignment.Left
timeLabel.Parent = frame

local bountyLabel = Instance.new("TextLabel")
bountyLabel.Name = "Bounty"
bountyLabel.Text = "Bounty: --"
bountyLabel.Font = Enum.Font.Gotham
bountyLabel.TextSize = 14
bountyLabel.TextColor3 = Color3.fromRGB(255,200,50)
bountyLabel.BackgroundTransparency = 1
bountyLabel.Position = UDim2.new(0.02, 0, 0.52, 0)
bountyLabel.Size = UDim2.new(0.6, 0, 0.18, 0)
bountyLabel.TextXAlignment = Enum.TextXAlignment.Left
bountyLabel.Parent = frame

-- Buttons: Next Player, Hop Server, Reset
local function makeButton(name, x, text)
    local b = Instance.new("TextButton")
    b.Name = name
    b.Text = text
    b.Font = Enum.Font.GothamSemibold
    b.TextSize = 14
    b.BackgroundColor3 = Color3.fromRGB(40,40,55)
    b.TextColor3 = Color3.fromRGB(230,230,230)
    b.Position = UDim2.new(x, 0, 0.72, 0)
    b.Size = UDim2.new(0.3, 0, 0.22, 0)
    b.Parent = frame
    local cor = Instance.new("UICorner", b)
    cor.CornerRadius = UDim.new(0,6)
    return b
end

local btnNext = makeButton("NextPlayer", 0.02, "Next Player")
local btnHop  = makeButton("HopServer", 0.35, "Hop Server")
local btnReset = makeButton("ResetAll", 0.68, "Reset")

-- Small square toggle on top-left (draggable)
local toggleSquare = Instance.new("Frame")
toggleSquare.Name = "ToggleSquare"
toggleSquare.Size = UDim2.new(0, 36, 0, 36)
toggleSquare.Position = UDim2.new(0, 8, 0, 8)
toggleSquare.BackgroundColor3 = Color3.fromRGB(40,40,55)
toggleSquare.BorderSizePixel = 0
toggleSquare.Parent = gui
local tsCorner = Instance.new("UICorner", toggleSquare)
tsCorner.CornerRadius = UDim.new(0,6)
local tsLabel = Instance.new("TextLabel", toggleSquare)
tsLabel.Size = UDim2.new(1,0,1,0)
tsLabel.BackgroundTransparency = 1
tsLabel.Text = "UI"
tsLabel.TextColor3 = Color3.fromRGB(230,230,230)
tsLabel.Font = Enum.Font.GothamSemibold
tsLabel.TextSize = 14

-- Draggable behavior for frame and toggleSquare
local dragging = false
local dragInput, dragStart, startPos

local function makeDraggable(clr)
    local dragObj = clr
    dragObj.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = dragObj.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    dragObj.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            dragObj.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

makeDraggable(frame)
makeDraggable(toggleSquare)

-- Button actions
btnNext.MouseButton1Click:Connect(function()
    -- skip current target to next
    if currentTarget then
        currentTarget = nil
        lastTargetSkipTick = tick()
    end
end)

btnHop.MouseButton1Click:Connect(function()
    -- attempt server hop immediately (user requested)
    serverHop()
end)

btnReset.MouseButton1Click:Connect(function()
    -- Reset states
    currentTarget = nil
    setNoClip(false)
    ensurePvP()
    ensureBuso()
    ensureKen()
    equipDefaultMelee()
end)

-- Update UI loop (time + bounty)
spawn(function()
    while true do
        pcall(function()
            timeLabel.Text = os.date("%H:%M:%S")
            -- bounty display (best-effort)
            local display = "--"
            local ok, val = pcall(function()
                local ls = LocalPlayer:FindFirstChild("leaderstats")
                if ls then
                    local b = ls:FindFirstChild("Bounty/Honor") or ls:FindFirstChild("Bounty")
                    if b then return tostring(b.Value) end
                end
                return nil
            end)
            if ok and val then display = val end
            bountyLabel.Text = "Bounty: "..display
        end)
        task.wait(1)
    end
end)

-- Start/Stop API
local mainThread = nil
function startAutoBounty()
    if running then return end
    running = true
    mainThread = task.spawn(function() mainLoop() end)
end
function stopAutoBounty()
    running = false
    if mainThread then
        task.cancel(mainThread)
        mainThread = nil
    end
    setNoClip(false)
end

-- Auto start if configured
if cfg.AutoStart then
    task.spawn(function()
        repeat task.wait() until game:IsLoaded()
        task.wait(1)
        startAutoBounty()
    end)
end

-- Expose simple global control
_G.PHUCMAX_AutoBounty = _G.PHUCMAX_AutoBounty or {}
_G.PHUCMAX_AutoBounty.Start = startAutoBounty
_G.PHUCMAX_AutoBounty.Stop = stopAutoBounty
_G.PHUCMAX_AutoBounty.GetState = function() return running, currentTarget end

print("[PHUCMAX Auto Bounty] Loaded. AutoStart=", tostring(cfg.AutoStart))

-- End of file